<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tilføj valgsteder</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root { --border:#e8e8e8; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    .wrap { display: grid; grid-template-columns: 420px 1fr; height: 100vh; }
    .panel { padding: 14px; border-right: 1px solid var(--border); overflow: auto; }
    h2 { font-size: 16px; margin: 0 0 12px; }
    label { display: block; font-size: 12px; color:#444; margin-top: 10px; }

    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      background: #fafafa;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 10px;
    }
    button.primary { background: #111; color: #fff; border-color:#111; }
    button:disabled { opacity: .6; cursor: not-allowed; }

    .hint { font-size: 12px; color:#666; margin-top: 8px; line-height: 1.35; }
    #map { height: 100vh; }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .status { margin-top: 10px; font-size: 12px; color:#333; white-space: pre-wrap; }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; font-size: 12px; padding: 8px 6px; border-bottom: 1px solid #f0f0f0; vertical-align: top; }
    th { color:#666; font-weight: 600; }

    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 3px 8px; border: 1px solid #0001; border-radius: 999px;
      background: #fff;
      white-space: nowrap;
    }
    .swatch { width: 10px; height: 10px; border-radius: 50%; border: 1px solid #0002; display:inline-block; }

    .actions { display:flex; gap:6px; flex-wrap: nowrap; align-items:center; }
    .mini {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      width: auto;
      margin-top: 0;
      white-space: nowrap;
    }
    .mini.primary { background:#111; color:#fff; border-color:#111; }

    .section { margin-top: 12px; border-top: 1px solid var(--border); padding-top: 10px; }

    details {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      padding: 8px 10px;
      margin-top: 10px;
    }
    summary {
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #333;
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    summary::-webkit-details-marker { display: none; }
    .summaryRight { font-size: 12px; color:#666; font-weight: 500; }

    .filterBtns { display:flex; gap:6px; margin-top: 8px; }
    .filterGrid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 6px 10px; margin-top: 10px; }
    .filterItem { display:flex; align-items:center; gap:8px; font-size:12px; }
    .filterItem input { transform: translateY(1px); }

    .inlineInput { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 12px; }
    .inlineSelect { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 12px; background: #fff; }
    .inlineNumber { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 12px; }

    .controlsRow { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    @media (max-width: 420px) {
      .filterGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <h2>Tilføj valgsteder</h2>

      <label for="kreds">Kreds</label>
      <select id="kreds"></select>

      <label for="name">Navn</label>
      <input id="name" type="text" placeholder="f.eks. 1. Nord, Strandvejsskolen"/>

      <label for="address">Adresse</label>
      <input id="address" type="text" placeholder="Fx 'Rådhuspladsen 1, 1550 København'"/>

      <div class="row2">
        <div>
          <label for="color">Farve</label>
          <select id="color"></select>
        </div>
        <div>
          <label for="radiusNumber">Størrelse (px) (max 20)</label>
          <input id="radiusNumber" type="number" min="2" max="20" value="12" />
        </div>
      </div>

      <label for="opacityNumber">Opacity (0–1)</label>
      <div class="controlsRow">
        <input id="opacityRange" type="range" min="0" max="1" step="0.05" value="0.55" />
        <input id="opacityNumber" type="number" min="0" max="1" step="0.05" value="0.55" />
      </div>
      <div class="hint">Opacity gælder for alle cirkler og gemmes automatisk.</div>

      <button id="add" class="primary">Tilføj</button>

      <div id="status" class="status"></div>

      <div class="section">
        <details open>
          <summary>
            Filtre
            <span class="summaryRight" id="filterSummary"></span>
          </summary>

          <details open>
            <summary>
              Kredse
              <span class="summaryRight" id="kredsSummary"></span>
            </summary>
            <div class="filterBtns">
              <button class="mini" id="kredsAll">Vælg alle</button>
              <button class="mini" id="kredsNone">Fjern alle</button>
            </div>
            <div class="filterGrid" id="kredsFilters"></div>
          </details>

          <details open>
            <summary>
              Farver
              <span class="summaryRight" id="colorSummary"></span>
            </summary>
            <div class="filterBtns">
              <button class="mini" id="colorAll">Vælg alle</button>
              <button class="mini" id="colorNone">Fjern alle</button>
            </div>
            <div class="filterGrid" id="colorFilters"></div>
          </details>
        </details>
      </div>

      <div class="section">
        <details open>
          <summary>
            Liste
            <span class="summaryRight" id="listSummary"></span>
          </summary>
          <div id="kredsLists"></div>
        </details>
      </div>

      <div class="section">
        <details>
          <summary>
            Masseændringer
            <span class="summaryRight"></span>
          </summary>

          <div class="row2" style="margin-top:10px;">
            <div>
              <label for="bulkRadiusNumber">Sæt størrelse for alle (px) (max 20)</label>
              <input id="bulkRadiusNumber" type="number" min="2" max="20" value="12" />
              <button id="applyBulkRadius" class="mini primary" style="margin-top:8px;">Anvend størrelse til alle</button>
            </div>

            <div>
              <label for="bulkColor">Sæt farve for alle</label>
              <select id="bulkColor"></select>
              <button id="applyBulkColor" class="mini" style="margin-top:8px;">Anvend farve til alle</button>
            </div>
          </div>

          <button id="clearAllStorage" class="mini" style="margin-top:12px;">Slet alle gemte valgsteder</button>
          <div class="hint">Dette fjerner alt gemt i browseren (localStorage).</div>
        </details>
      </div>

    </div>

    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ----------------- Konfiguration -----------------
    const PER_REQUEST_DELAY_MS = 80;
    const LIMIT_TO_CPH = true; // geokodning begrænses i baggrunden til kommunekode 0101
    const STORAGE_KEY = "valgsteder_state_v2";

    // Kommunegrænse styling (match-ish til dit eksempel)
    const CPH_BOUNDARY_STYLE = {
      color: "#e11d48",
      weight: 3,
      fillColor: "#e11d48",
      fillOpacity: 0.08
    };

    const COLOR_PRESETS = [
      { label: "Rød",   value: "#e11d48" },
      { label: "Blå",   value: "#2563eb" },
      { label: "Grøn",  value: "#16a34a" },
      { label: "Orange",value: "#f97316" },
      { label: "Lilla", value: "#7c3aed" },
      { label: "Sort",  value: "#111827" },
      { label: "Grå",   value: "#6b7280" },
    ];
    const COLOR_LABEL_BY_VALUE = Object.fromEntries(COLOR_PRESETS.map(c => [c.value, c.label]));

    // ----------------- Kort -----------------
    const map = L.map('map').setView([55.6761, 12.5683], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Pane til kommunegrænse (over tiles, under markører)
    map.createPane('boundaryPane');
    map.getPane('boundaryPane').style.zIndex = 450;
    map.getPane('boundaryPane').style.pointerEvents = 'none';

    const markerGroup = L.layerGroup().addTo(map);

    // ----------------- State -----------------
    // entry: {id, kreds, name, address, color, radius, lat, lng}
    const entries = [];

    const selectedKredse = new Set([1,2,3,4,5,6,7,8,9]);
    const selectedColors = new Set(COLOR_PRESETS.map(c => c.value));

    let currentOpacity = 0.55;

    const markerById = new Map();
    const editingIds = new Set();
    const backups = new Map();

    // ----------------- Helpers -----------------
    const statusEl = document.getElementById('status');
    function setStatus(msg) { statusEl.textContent = msg || ''; }

    function escapeHtml(str) {
      return String(str ?? '').replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    function uuid() {
      return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random());
    }

    function clampRadius(v) {
      const n = Number(v);
      if (!Number.isFinite(n)) return 12;
      return Math.max(2, Math.min(20, Math.round(n)));
    }

    function clampOpacity(v) {
      const n = Number(v);
      if (!Number.isFinite(n)) return currentOpacity;
      return Math.max(0, Math.min(1, Math.round(n * 20) / 20)); // 0.05 step
    }

    function populateColorSelect(selectEl, defaultValue) {
      selectEl.innerHTML = '';
      for (const c of COLOR_PRESETS) {
        const opt = document.createElement('option');
        opt.value = c.value;
        opt.textContent = c.label;
        selectEl.appendChild(opt);
      }
      selectEl.value = defaultValue || COLOR_PRESETS[0].value;
    }

    function populateKredsSelect(selectEl) {
      selectEl.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'Vælg kreds…';
      selectEl.appendChild(opt0);
      for (let i=1;i<=9;i++) {
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = String(i);
        selectEl.appendChild(opt);
      }
      selectEl.value = '';
    }

    function isEntryVisible(e) {
      return selectedKredse.has(e.kreds) && selectedColors.has(e.color);
    }

    function markerPopupHtml(e) {
      const colorLabel = COLOR_LABEL_BY_VALUE[e.color] || '';
      return `
        <div style="line-height:1.3">
          <b>${escapeHtml(e.name || '(uden navn)')}</b><br/>
          Kreds: ${escapeHtml(e.kreds)}<br/>
          ${escapeHtml(e.address)}<br/>
          <span style="color:#666">${escapeHtml(colorLabel)}, ${escapeHtml(e.radius)}px</span>
        </div>
      `;
    }

    function ensureMarker(e) {
      let m = markerById.get(e.id);
      if (!m && Number.isFinite(e.lat) && Number.isFinite(e.lng)) {
        m = L.circleMarker([e.lat, e.lng], {
          radius: e.radius,
          color: e.color,
          fillColor: e.color,
          fillOpacity: currentOpacity,
          weight: 1
        }).bindPopup(markerPopupHtml(e));
        markerById.set(e.id, m);
      }
      return m || null;
    }

    function updateMarkerStyleAndPopup(e) {
      const m = markerById.get(e.id);
      if (!m) return;
      m.setStyle({
        color: e.color,
        fillColor: e.color,
        fillOpacity: currentOpacity,
        weight: 1
      });
      m.setRadius(e.radius);
      m.bindPopup(markerPopupHtml(e));
    }

    function updateVisibility() {
      for (const e of entries) {
        const m = ensureMarker(e);
        if (!m) continue;
        if (isEntryVisible(e)) {
          if (!markerGroup.hasLayer(m)) markerGroup.addLayer(m);
        } else {
          if (markerGroup.hasLayer(m)) markerGroup.removeLayer(m);
        }
      }
      updateSummaries();
    }

    function updateAllMarkersOpacity() {
      for (const e of entries) {
        const m = markerById.get(e.id);
        if (!m) continue;
        m.setStyle({ fillOpacity: currentOpacity });
      }
      updateVisibility();
    }

    // ----------------- Kommunegrænse: København -----------------
    async function addCphMunicipalityBoundary() {
      try {
        // Hent alle kommuner som GeoJSON og filtrér på kode 0101 (København)
        const url = "https://api.dataforsyningen.dk/kommuner/?format=geojson";
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const geo = await res.json();
        const feature = (geo.features || []).find(f => String((f.properties || {}).kode || "") === "0101")
                      || (geo.features || []).find(f => /københavn/i.test(String((f.properties || {}).navn || "")));

        if (!feature) return;

        const boundary = L.geoJSON(feature, {
          pane: "boundaryPane",
          style: () => CPH_BOUNDARY_STYLE
        }).addTo(map);

        // Lidt “ekstra”: sørg for at den bliver liggende under markører
        boundary.bringToBack();

        // Hvis du vil zoome til kommunen første gang:
        // map.fitBounds(boundary.getBounds(), { padding: [20, 20] });
      } catch (e) {
        // Hvis den fejler (fx file:// CORS), ignorerer vi bare grænsen
        console.warn("Kunne ikke indlæse kommunegrænse:", e);
      }
    }

    // ----------------- Persistence -----------------
    function saveState() {
      const state = {
        version: 2,
        opacity: currentOpacity,
        selectedKredse: [...selectedKredse],
        selectedColors: [...selectedColors],
        entries: entries.map(e => ({
          id: e.id,
          kreds: e.kreds,
          name: e.name,
          address: e.address,
          color: e.color,
          radius: e.radius,
          lat: e.lat,
          lng: e.lng
        }))
      };
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch {}
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;

        const s = JSON.parse(raw);
        if (!s || !Array.isArray(s.entries)) return;

        currentOpacity = clampOpacity(s.opacity ?? 0.55);

        selectedKredse.clear();
        for (const k of (s.selectedKredse ?? [1,2,3,4,5,6,7,8,9])) selectedKredse.add(Number(k));

        selectedColors.clear();
        for (const c of (s.selectedColors ?? COLOR_PRESETS.map(x => x.value))) selectedColors.add(c);

        entries.splice(0, entries.length);
        for (const e of s.entries) {
          entries.push({
            id: e.id || uuid(),
            kreds: Number(e.kreds) || 1,
            name: e.name || "",
            address: e.address || "",
            color: e.color || COLOR_PRESETS[0].value,
            radius: clampRadius(e.radius ?? 12),
            lat: (typeof e.lat === "number" ? e.lat : undefined),
            lng: (typeof e.lng === "number" ? e.lng : undefined),
          });
        }
      } catch {}
    }

    function clearStorage() {
      try { localStorage.removeItem(STORAGE_KEY); } catch {}
    }

    // ----------------- DAWA geokodning -----------------
    async function geocodeDAWA(address) {
      const params = new URLSearchParams();
      params.set('q', address);
      params.set('format', 'geojson');
      params.set('struktur', 'mini');
      params.set('srid', '4326');
      if (LIMIT_TO_CPH) params.set('kommunekode', '0101');

      const urls = [
        `https://api.dataforsyningen.dk/adresser?${params.toString()}`,
        `https://dawa.aws.dk/adresser?${params.toString()}`
      ];

      let lastErr = null;
      for (const url of urls) {
        try {
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const geo = await res.json();
          const feat = geo && geo.features && geo.features[0];
          if (!feat) return null;
          const [lng, lat] = feat.geometry.coordinates;
          return { lat, lng };
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('Geokodning fejlede');
    }

    async function geocodeAndSetCoords(e, { flyTo = true } = {}) {
      await new Promise(r => setTimeout(r, PER_REQUEST_DELAY_MS));
      const g = await geocodeDAWA(e.address);
      if (!g) return { ok:false, error:"Ingen match" };
      e.lat = g.lat; e.lng = g.lng;

      const m = ensureMarker(e);
      if (m) {
        m.setLatLng([e.lat, e.lng]);
        updateMarkerStyleAndPopup(e);
      }
      updateVisibility();

      if (flyTo) map.setView([e.lat, e.lng], Math.max(map.getZoom(), 14));
      return { ok:true };
    }

    // ----------------- Filters UI -----------------
    function renderKredsFilters() {
      const container = document.getElementById('kredsFilters');
      container.innerHTML = '';
      for (let k=1;k<=9;k++) {
        const id = `kreds_${k}`;
        const lab = document.createElement('label');
        lab.className = 'filterItem';
        lab.innerHTML = `
          <input type="checkbox" id="${id}" ${selectedKredse.has(k) ? 'checked' : ''}/>
          <span>${k}</span>
        `;
        container.appendChild(lab);
        lab.querySelector('input').addEventListener('change', (ev) => {
          if (ev.target.checked) selectedKredse.add(k);
          else selectedKredse.delete(k);
          updateVisibility();
          saveState();
          renderKredsSummaries();
        });
      }
      renderKredsSummaries();
    }

    function renderColorFilters() {
      const container = document.getElementById('colorFilters');
      container.innerHTML = '';
      for (const c of COLOR_PRESETS) {
        const id = `color_${btoa(c.value).replace(/=/g,'')}`;
        const lab = document.createElement('label');
        lab.className = 'filterItem';
        lab.innerHTML = `
          <input type="checkbox" id="${id}" ${selectedColors.has(c.value) ? 'checked' : ''}/>
          <span class="swatch" style="background:${c.value}"></span>
          <span>${c.label}</span>
        `;
        container.appendChild(lab);
        lab.querySelector('input').addEventListener('change', (ev) => {
          if (ev.target.checked) selectedColors.add(c.value);
          else selectedColors.delete(c.value);
          updateVisibility();
          saveState();
          renderColorSummaries();
        });
      }
      renderColorSummaries();
    }

    function setAllKredse(on) {
      selectedKredse.clear();
      if (on) for (let k=1;k<=9;k++) selectedKredse.add(k);
      renderKredsFilters();
      updateVisibility();
      saveState();
    }

    function setAllColors(on) {
      selectedColors.clear();
      if (on) for (const c of COLOR_PRESETS) selectedColors.add(c.value);
      renderColorFilters();
      updateVisibility();
      saveState();
    }

    function renderKredsSummaries() {
      document.getElementById('kredsSummary').textContent = `${selectedKredse.size}/9 valgt`;
    }
    function renderColorSummaries() {
      document.getElementById('colorSummary').textContent = `${selectedColors.size}/${COLOR_PRESETS.length} valgt`;
    }
    function updateSummaries() {
      const visible = entries.filter(isEntryVisible).length;
      document.getElementById('filterSummary').textContent = `${visible}/${entries.length} vises`;
      document.getElementById('listSummary').textContent = `${entries.length} total`;
      renderKredsSummaries();
      renderColorSummaries();
    }

    // ----------------- Liste pr. kreds -----------------
    function renderKredsLists() {
      const container = document.getElementById('kredsLists');
      container.innerHTML = '';

      const byK = new Map();
      for (let k=1;k<=9;k++) byK.set(k, []);
      for (const e of entries) byK.get(e.kreds)?.push(e);

      for (let k=1;k<=9;k++) {
        const list = byK.get(k) || [];
        const det = document.createElement('details');
        det.open = list.length > 0;
        det.style.marginTop = "10px";

        const visCount = list.filter(isEntryVisible).length;
        det.innerHTML = `
          <summary>
            Kreds ${k}
            <span class="summaryRight">${list.length} (viser ${visCount})</span>
          </summary>
          <div style="margin-top:10px;">
            ${list.length === 0 ? `<div class="hint">Ingen valgsteder.</div>` : `
              <table>
                <thead>
                  <tr>
                    <th style="width: 26%;">Navn</th>
                    <th>Adresse</th>
                    <th style="width: 18%;">Stil</th>
                    <th style="width: 18%;">Handling</th>
                  </tr>
                </thead>
                <tbody id="tbody_k${k}"></tbody>
              </table>
            `}
          </div>
        `;
        container.appendChild(det);

        if (list.length) {
          const tbody = det.querySelector(`#tbody_k${k}`);
          tbody.innerHTML = "";
          for (const e of list) {
            const tr = document.createElement('tr');
            const isEditing = editingIds.has(e.id);

            if (!isEditing) {
              const styleHtml = `
                <span class="pill">
                  <span class="swatch" style="background:${escapeHtml(e.color)}"></span>
                  ${escapeHtml(e.radius)}px
                </span>
              `;

              tr.innerHTML = `
                <td>${escapeHtml(e.name || '(uden navn)')}</td>
                <td>${escapeHtml(e.address)}</td>
                <td>${styleHtml}</td>
                <td>
                  <div class="actions">
                    <button class="mini" data-edit="${e.id}">Redigér</button>
                    <button class="mini" data-del="${e.id}">Slet</button>
                  </div>
                </td>
              `;
            } else {
              tr.innerHTML = `
                <td>
                  <div style="display:grid; gap:6px;">
                    <select class="inlineSelect" data-editkreds="${e.id}"></select>
                    <input class="inlineInput" data-editname="${e.id}" value="${escapeHtml(e.name || '')}" placeholder="Navn"/>
                  </div>
                </td>
                <td>
                  <input class="inlineInput" data-editaddr="${e.id}" value="${escapeHtml(e.address || '')}" placeholder="Adresse"/>
                </td>
                <td>
                  <div style="display:grid; gap:6px;">
                    <select class="inlineSelect" data-editcolor="${e.id}"></select>
                    <input class="inlineNumber" type="number" min="2" max="20" data-editradius="${e.id}" value="${escapeHtml(e.radius)}"/>
                  </div>
                </td>
                <td>
                  <div class="actions">
                    <button class="mini primary" data-save="${e.id}">Gem</button>
                    <button class="mini" data-cancel="${e.id}">Fortryd</button>
                  </div>
                </td>
              `;
            }

            if (!isEntryVisible(e)) tr.style.opacity = "0.5";
            tbody.appendChild(tr);

            if (isEditing) {
              const kredsSel = tr.querySelector(`select[data-editkreds="${CSS.escape(e.id)}"]`);
              const colorSel = tr.querySelector(`select[data-editcolor="${CSS.escape(e.id)}"]`);
              if (kredsSel) { populateKredsSelect(kredsSel); kredsSel.value = String(e.kreds); }
              if (colorSel) { populateColorSelect(colorSel, e.color); }
            }
          }
        }
      }

      container.querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-del');
          const idx = entries.findIndex(x => x.id === id);
          if (idx < 0) return;

          const e = entries[idx];
          const m = markerById.get(e.id);
          if (m) {
            if (markerGroup.hasLayer(m)) markerGroup.removeLayer(m);
            m.remove();
            markerById.delete(e.id);
          }

          editingIds.delete(e.id);
          backups.delete(e.id);

          entries.splice(idx, 1);
          saveState();
          renderKredsLists();
          updateVisibility();
          setStatus('');
        });
      });

      container.querySelectorAll('button[data-edit]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-edit');
          const e = entries.find(x => x.id === id);
          if (!e) return;

          backups.set(id, { ...e });
          editingIds.add(id);
          renderKredsLists();
          setStatus('');
        });
      });

      container.querySelectorAll('button[data-cancel]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-cancel');
          const e = entries.find(x => x.id === id);
          const b = backups.get(id);
          if (e && b) {
            e.kreds = b.kreds;
            e.name = b.name;
            e.address = b.address;
            e.color = b.color;
            e.radius = b.radius;
            e.lat = b.lat;
            e.lng = b.lng;

            ensureMarker(e);
            updateMarkerStyleAndPopup(e);
            updateVisibility();
          }
          editingIds.delete(id);
          backups.delete(id);
          renderKredsLists();
          setStatus('');
        });
      });

      container.querySelectorAll('button[data-save]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-save');
          const e = entries.find(x => x.id === id);
          const b = backups.get(id);
          if (!e || !b) return;

          const kredsSel = container.querySelector(`select[data-editkreds="${CSS.escape(id)}"]`);
          const nameInp  = container.querySelector(`input[data-editname="${CSS.escape(id)}"]`);
          const addrInp  = container.querySelector(`input[data-editaddr="${CSS.escape(id)}"]`);
          const colorSel = container.querySelector(`select[data-editcolor="${CSS.escape(id)}"]`);
          const radInp   = container.querySelector(`input[data-editradius="${CSS.escape(id)}"]`);

          const newKreds = Number(kredsSel?.value || 0);
          const newName  = (nameInp?.value ?? "").trim();
          const newAddr  = (addrInp?.value ?? "").trim();
          const newColor = (colorSel?.value ?? e.color);
          const newRad   = clampRadius(radInp?.value ?? e.radius);

          if (!newKreds || newKreds < 1 || newKreds > 9) { setStatus('Vælg en kreds (1–9).'); return; }
          if (!newAddr) { setStatus('Adresse må ikke være tom.'); return; }

          const oldAddr = e.address;

          e.kreds = newKreds;
          e.name = newName;
          e.address = newAddr;
          e.color = newColor;
          e.radius = newRad;

          try {
            if (newAddr !== oldAddr) {
              const r = await geocodeAndSetCoords(e, { flyTo: true });
              if (!r.ok) throw new Error("Ingen match på adresse");
            } else {
              ensureMarker(e);
              updateMarkerStyleAndPopup(e);
              updateVisibility();
            }

            editingIds.delete(id);
            backups.delete(id);
            saveState();
            renderKredsLists();
            setStatus('');
          } catch (err) {
            e.kreds = b.kreds;
            e.name = b.name;
            e.address = b.address;
            e.color = b.color;
            e.radius = b.radius;
            e.lat = b.lat;
            e.lng = b.lng;

            ensureMarker(e);
            updateMarkerStyleAndPopup(e);
            updateVisibility();

            setStatus(
              'Kunne ikke gemme ændringer.\n' +
              'Hvis du åbner som file://, så prøv via http://localhost (lokal server).\n\n' +
              `Fejl: ${String(err?.message || err)}`
            );
          }
        });
      });

      updateSummaries();
    }

    // ----------------- Add handler -----------------
    async function addEntry() {
      const btn = document.getElementById('add');
      btn.disabled = true;

      const kredsVal = document.getElementById('kreds').value;
      const kreds = Number(kredsVal);
      const name = document.getElementById('name').value.trim();
      const address = document.getElementById('address').value.trim();
      const color = document.getElementById('color').value;
      const radius = clampRadius(document.getElementById('radiusNumber').value);

      if (!kreds || kreds < 1 || kreds > 9) {
        setStatus('Vælg en kreds (1–9) før du tilføjer.');
        btn.disabled = false;
        return;
      }
      if (!address) {
        setStatus('Skriv en adresse før du tilføjer.');
        btn.disabled = false;
        return;
      }

      const e = { id: uuid(), kreds, name, address, color, radius, lat: undefined, lng: undefined };
      entries.push(e);
      renderKredsLists();
      setStatus('');

      try {
        const r = await geocodeAndSetCoords(e, { flyTo: true });
        if (!r.ok) throw new Error("Ingen match");

        document.getElementById('name').value = '';
        document.getElementById('address').value = '';
        document.getElementById('address').focus();

        saveState();
        renderKredsLists();
        updateVisibility();
        setStatus('');
      } catch (err) {
        const idx = entries.findIndex(x => x.id === e.id);
        if (idx >= 0) entries.splice(idx, 1);
        renderKredsLists();
        updateVisibility();

        setStatus(
          'Kunne ikke hente koordinater.\n' +
          'Hvis du åbner som file://, så prøv via http://localhost (lokal server).\n\n' +
          `Fejl: ${String(err?.message || err)}`
        );
      } finally {
        btn.disabled = false;
      }
    }

    // ----------------- Bulk handlers -----------------
    function applyBulkRadius() {
      const r = clampRadius(document.getElementById('bulkRadiusNumber').value);
      if (entries.length === 0) { setStatus('Der er ingen punkter at opdatere.'); return; }

      for (const e of entries) {
        e.radius = r;
        ensureMarker(e);
        updateMarkerStyleAndPopup(e);
      }
      saveState();
      renderKredsLists();
      updateVisibility();
      setStatus('');
    }

    function applyBulkColor() {
      const c = document.getElementById('bulkColor').value;
      if (entries.length === 0) { setStatus('Der er ingen punkter at opdatere.'); return; }

      for (const e of entries) {
        e.color = c;
        ensureMarker(e);
        updateMarkerStyleAndPopup(e);
      }
      saveState();
      renderKredsLists();
      updateVisibility();
      setStatus('');
    }

    // ----------------- Opacity sync -----------------
    const opacityRange = document.getElementById('opacityRange');
    const opacityNumber = document.getElementById('opacityNumber');

    function syncOpacityFrom(source) {
      currentOpacity = clampOpacity(source.value);
      opacityRange.value = String(currentOpacity);
      opacityNumber.value = String(currentOpacity);
      updateAllMarkersOpacity();
      saveState();
      setStatus('');
    }

    // ----------------- Init -----------------
    populateKredsSelect(document.getElementById('kreds'));
    populateColorSelect(document.getElementById('color'), COLOR_PRESETS[0].value);
    populateColorSelect(document.getElementById('bulkColor'), COLOR_PRESETS[0].value);

    loadState();

    opacityRange.value = String(currentOpacity);
    opacityNumber.value = String(currentOpacity);

    for (const e of entries) {
      ensureMarker(e);
      updateMarkerStyleAndPopup(e);
    }

    renderKredsFilters();
    renderColorFilters();
    renderKredsLists();
    updateVisibility();
    updateSummaries();

    // Tegn kommunegrænsen (overlay)
    addCphMunicipalityBoundary();

    // bind
    document.getElementById('add').addEventListener('click', addEntry);
    document.getElementById('applyBulkRadius').addEventListener('click', applyBulkRadius);
    document.getElementById('applyBulkColor').addEventListener('click', applyBulkColor);

    document.getElementById('kredsAll').addEventListener('click', () => setAllKredse(true));
    document.getElementById('kredsNone').addEventListener('click', () => setAllKredse(false));
    document.getElementById('colorAll').addEventListener('click', () => setAllColors(true));
    document.getElementById('colorNone').addEventListener('click', () => setAllColors(false));

    opacityRange.addEventListener('input', () => syncOpacityFrom(opacityRange));
    opacityNumber.addEventListener('input', () => syncOpacityFrom(opacityNumber));

    document.getElementById('address').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('add').click();
      }
    });

    document.getElementById('clearAllStorage').addEventListener('click', () => {
      if (!confirm("Vil du slette alle gemte valgsteder?")) return;
      clearStorage();

      for (const m of markerById.values()) {
        if (markerGroup.hasLayer(m)) markerGroup.removeLayer(m);
        m.remove();
      }
      markerById.clear();
      entries.splice(0, entries.length);
      editingIds.clear();
      backups.clear();

      selectedKredse.clear(); for (let k=1;k<=9;k++) selectedKredse.add(k);
      selectedColors.clear(); for (const c of COLOR_PRESETS) selectedColors.add(c.value);

      renderKredsFilters();
      renderColorFilters();
      renderKredsLists();
      updateVisibility();
      setStatus('');
    });
  </script>
</body>
</html>
