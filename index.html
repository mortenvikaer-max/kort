<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tilføj valgsteder</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root { --border:#e8e8e8; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    .wrap { display: grid; grid-template-columns: 420px 1fr; height: 100vh; }
    .panel { padding: 14px; border-right: 1px solid var(--border); overflow: auto; }
    h2 { font-size: 16px; margin: 0 0 12px; }
    label { display: block; font-size: 12px; color:#444; margin-top: 10px; }
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      background: #fafafa;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 10px;
    }
    button.primary { background: #111; color: #fff; border-color:#111; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .hint { font-size: 12px; color:#666; margin-top: 8px; line-height: 1.35; }
    #map { height: 100vh; }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .list { margin-top: 12px; border-top: 1px solid var(--border); padding-top: 10px; }
    .list h3 { font-size: 13px; margin: 0 0 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; font-size: 12px; padding: 8px 6px; border-bottom: 1px solid #f0f0f0; vertical-align: top; }
    th { color:#666; font-weight: 600; }

    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 3px 8px; border: 1px solid #0001; border-radius: 999px;
      background: #fff;
      white-space: nowrap;
    }
    .swatch { width: 10px; height: 10px; border-radius: 50%; border: 1px solid #0002; display:inline-block; }

    .actions { display:flex; gap:6px; flex-wrap: nowrap; }
    .mini {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      width: auto;
      margin-top: 0;
      white-space: nowrap;
    }
    .mini.primary { background:#111; color:#fff; border-color:#111; }

    .legend { margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border); }
    .legend h3 { font-size: 13px; margin: 0 0 8px; }
    .legend-item { display:flex; align-items:center; gap:8px; margin: 6px 0; font-size: 12px; }

    .status { margin-top: 10px; font-size: 12px; color:#333; white-space: pre-wrap; }

    /* slider + preview */
    .sliderRow {
      display: grid;
      grid-template-columns: 1fr 78px auto;
      align-items: center;
      gap: 10px;
    }
    input[type="range"] { width: 100%; }
    .previewDot {
      border-radius: 50%;
      border: 1px solid #0002;
      background: #111;
      display: inline-block;
      flex: none;
      width: 24px;
      height: 24px;
    }

    .bulk { margin-top: 12px; border-top: 1px solid var(--border); padding-top: 10px; }
    .bulk h3 { font-size: 13px; margin: 0 0 8px; }
    .bulk .mini { margin-top: 8px; }

    /* small select/inputs inside table edit mode */
    .inlineInput { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 12px; }
    .inlineSelect { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 12px; background: #fff; }
    .inlineNumber { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <h2>Tilføj valgsteder</h2>

      <label for="name">Navn</label>
      <input id="name" type="text" placeholder="Fx 'Valgsted 1'"/>

      <label for="address">Adresse</label>
      <input id="address" type="text" placeholder="Fx 'Rådhuspladsen 1, 1550 København'"/>

      <div class="row2">
        <div>
          <label for="color">Farve</label>
          <select id="color"></select>
        </div>

        <div>
          <label>Størrelse (px)</label>
          <div class="sliderRow">
            <input id="radiusRange" type="range" min="2" max="50" value="12" />
            <input id="radiusNumber" type="number" min="2" max="50" value="12" />
            <span id="addPreviewDot" class="previewDot" title="Preview"></span>
          </div>
        </div>
      </div>

      <button id="add" class="primary">Tilføj</button>

      <div id="status" class="status"></div>

      <div class="bulk">
        <h3>Redigér alle samlet</h3>

        <div class="row2">
          <div>
            <label>Sæt størrelse for alle (px)</label>
            <div class="sliderRow">
              <input id="bulkRadiusRange" type="range" min="2" max="50" value="12" />
              <input id="bulkRadiusNumber" type="number" min="2" max="50" value="12" />
              <span id="bulkPreviewDot" class="previewDot" title="Preview"></span>
            </div>
            <button id="applyBulkRadius" class="mini primary">Anvend størrelse til alle</button>
          </div>

          <div>
            <label for="bulkColor">Sæt farve for alle</label>
            <select id="bulkColor"></select>
            <button id="applyBulkColor" class="mini">Anvend farve til alle</button>
          </div>
        </div>
      </div>

      <div class="list">
        <h3>Liste</h3>
        <div class="hint">Du kan tilføje op til ca. 100 ad gangen.</div>

        <table>
          <thead>
            <tr>
              <th style="width: 26%;">Navn</th>
              <th>Adresse</th>
              <th style="width: 20%;">Stil</th>
              <th style="width: 22%;">Handling</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="4" style="color:#777;">Ingen punkter endnu.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="legend">
        <h3>Legend / filtre (kort)</h3>
        <div id="legendList" class="hint">Ingen data endnu.</div>
      </div>
    </div>

    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --------- Konfiguration ---------
    const FIXED_FILL_OPACITY = 0.55;
    const PER_REQUEST_DELAY_MS = 80;

    // (UI er fjernet, men vi begrænser stadig til Københavns kommune i baggrunden)
    const LIMIT_TO_CPH = true;

    const COLOR_PRESETS = [
      { label: "Rød",   value: "#e11d48" },
      { label: "Blå",   value: "#2563eb" },
      { label: "Grøn",  value: "#16a34a" },
      { label: "Orange",value: "#f97316" },
      { label: "Lilla", value: "#7c3aed" },
      { label: "Sort",  value: "#111827" },
      { label: "Grå",   value: "#6b7280" },
    ];

    // --------- Kort ---------
    const map = L.map('map').setView([55.6761, 12.5683], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const layersByColor = new Map();
    function getLayer(color) {
      if (!layersByColor.has(color)) layersByColor.set(color, L.layerGroup().addTo(map));
      return layersByColor.get(color);
    }

    function removeEmptyLayers() {
      for (const [color, layer] of [...layersByColor.entries()]) {
        if (layer.getLayers().length === 0) {
          if (map.hasLayer(layer)) map.removeLayer(layer);
          layersByColor.delete(color);
        }
      }
    }

    // --------- UI / data ---------
    // entry: {id, name, address, color, radius, lat?, lng?, marker?, isEditing?}
    const entries = [];

    const statusEl = document.getElementById('status');
    function setStatus(msg) { statusEl.textContent = msg || ''; }

    function escapeHtml(str) {
      return String(str ?? '').replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    function uuid() {
      return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random());
    }

    function clampRadius(v) {
      const n = Number(v);
      if (!Number.isFinite(n)) return 12;
      return Math.max(2, Math.min(50, Math.round(n)));
    }

    function populateColorSelect(selectEl, defaultValue) {
      selectEl.innerHTML = '';
      for (const c of COLOR_PRESETS) {
        const opt = document.createElement('option');
        opt.value = c.value;
        opt.textContent = c.label;
        selectEl.appendChild(opt);
      }
      selectEl.value = defaultValue || COLOR_PRESETS[0].value;
    }

    function setPreviewDot(dotEl, radius, color) {
      const r = clampRadius(radius);
      dotEl.style.width = (r * 2) + 'px';
      dotEl.style.height = (r * 2) + 'px';
      dotEl.style.background = color || '#111';
    }

    // --------- DAWA geokodning ---------
    async function geocodeDAWA(address) {
      const params = new URLSearchParams();
      params.set('q', address);
      params.set('format', 'geojson');
      params.set('struktur', 'mini');
      params.set('srid', '4326');
      if (LIMIT_TO_CPH) params.set('kommunekode', '0101');

      const urls = [
        `https://api.dataforsyningen.dk/adresser?${params.toString()}`,
        `https://dawa.aws.dk/adresser?${params.toString()}`
      ];

      let lastErr = null;
      for (const url of urls) {
        try {
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const geo = await res.json();
          const feat = geo && geo.features && geo.features[0];
          if (!feat) return null;
          const [lng, lat] = feat.geometry.coordinates;
          return { lat, lng };
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('Geokodning fejlede');
    }

    function markerPopupHtml(e) {
      return `
        <div style="line-height:1.3">
          <b>${escapeHtml(e.name || '(uden navn)')}</b><br/>
          ${escapeHtml(e.address)}<br/>
          <span style="color:#666">${escapeHtml(e.radius)}px</span>
        </div>
      `;
    }

    function ensureMarkerInCorrectLayer(e, oldColor) {
      if (!e.marker) return;
      if (!oldColor || oldColor === e.color) return;

      e.marker.remove();
      const newLayer = getLayer(e.color);
      e.marker.addTo(newLayer);
      removeEmptyLayers();
    }

    function updateMarkerStyleAndPopup(e) {
      if (!e.marker) return;

      e.marker.setStyle({
        color: e.color,
        fillColor: e.color,
        fillOpacity: FIXED_FILL_OPACITY,
        weight: 1
      });
      e.marker.setRadius(e.radius);
      e.marker.bindPopup(markerPopupHtml(e));
    }

    async function geocodeAndPlaceOrMoveMarker(e, { flyTo = true } = {}) {
      await new Promise(r => setTimeout(r, PER_REQUEST_DELAY_MS));

      const g = await geocodeDAWA(e.address);
      if (!g) return { ok: false, error: 'Ingen match' };

      e.lat = g.lat;
      e.lng = g.lng;

      if (!e.marker) {
        const layer = getLayer(e.color);
        e.marker = L.circleMarker([e.lat, e.lng], {
          radius: e.radius,
          color: e.color,
          fillColor: e.color,
          fillOpacity: FIXED_FILL_OPACITY,
          weight: 1
        }).bindPopup(markerPopupHtml(e)).addTo(layer);
      } else {
        e.marker.setLatLng([e.lat, e.lng]);
      }

      updateMarkerStyleAndPopup(e);

      if (flyTo) {
        map.setView([e.lat, e.lng], Math.max(map.getZoom(), 14));
      }

      return { ok: true };
    }

    // --------- Legend / filtre ---------
    function buildLegend() {
      const legendEl = document.getElementById('legendList');
      legendEl.innerHTML = '';

      if (layersByColor.size === 0) {
        legendEl.textContent = 'Ingen data endnu.';
        return;
      }

      for (const [color, layer] of layersByColor.entries()) {
        const id = 'chk_' + btoa(color).replace(/=/g,'');
        const row = document.createElement('div');
        row.className = 'legend-item';

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.id = id;
        chk.checked = map.hasLayer(layer);
        chk.addEventListener('change', () => {
          if (chk.checked) layer.addTo(map);
          else map.removeLayer(layer);
        });

        const sw = document.createElement('span');
        sw.className = 'swatch';
        sw.style.background = color;

        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = color;

        row.appendChild(chk);
        row.appendChild(sw);
        row.appendChild(label);
        legendEl.appendChild(row);
      }
    }

    // --------- Table rendering (view + edit) ---------
    function renderTable() {
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';

      if (entries.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" style="color:#777;">Ingen punkter endnu.</td>`;
        tbody.appendChild(tr);
        return;
      }

      for (const e of entries) {
        const tr = document.createElement('tr');

        if (!e.isEditing) {
          const styleHtml = `
            <span class="pill">
              <span class="swatch" style="background:${escapeHtml(e.color)}"></span>
              ${escapeHtml(e.radius)}px
            </span>
          `;

          tr.innerHTML = `
            <td>${escapeHtml(e.name || '(uden navn)')}</td>
            <td>${escapeHtml(e.address)}</td>
            <td>${styleHtml}</td>
            <td>
              <div class="actions">
                <button class="mini" data-edit="${e.id}">Redigér</button>
                <button class="mini" data-del="${e.id}">Slet</button>
              </div>
            </td>
          `;
        } else {
          const colorSelectId = `editColor_${e.id}`;
          const radiusRangeId = `editRadiusRange_${e.id}`;
          const radiusNumberId = `editRadiusNumber_${e.id}`;
          const previewId = `editPreview_${e.id}`;

          tr.innerHTML = `
            <td>
              <input class="inlineInput" data-name="${e.id}" value="${escapeHtml(e.name || '')}" placeholder="Navn"/>
            </td>
            <td>
              <input class="inlineInput" data-address="${e.id}" value="${escapeHtml(e.address || '')}" placeholder="Adresse"/>
            </td>
            <td>
              <div style="display:grid; gap:6px;">
                <select class="inlineSelect" id="${colorSelectId}" data-color="${e.id}"></select>

                <div class="sliderRow">
                  <input id="${radiusRangeId}" type="range" min="2" max="50" value="${escapeHtml(e.radius)}" data-radiusrange="${e.id}"/>
                  <input id="${radiusNumberId}" class="inlineNumber" type="number" min="2" max="50" value="${escapeHtml(e.radius)}" data-radiusnumber="${e.id}"/>
                  <span id="${previewId}" class="previewDot"></span>
                </div>
              </div>
            </td>
            <td>
              <div class="actions">
                <button class="mini primary" data-save="${e.id}">Gem</button>
                <button class="mini" data-cancel="${e.id}">Fortryd</button>
              </div>
            </td>
          `;
        }

        tbody.appendChild(tr);

        // Edit mode wiring
        if (e.isEditing) {
          const sel = tr.querySelector(`select[data-color="${CSS.escape(e.id)}"]`) || document.getElementById(`editColor_${e.id}`);
          if (sel) populateColorSelect(sel, e.color);

          const rangeEl = document.getElementById(`editRadiusRange_${e.id}`);
          const numberEl = document.getElementById(`editRadiusNumber_${e.id}`);
          const previewEl = document.getElementById(`editPreview_${e.id}`);

          if (rangeEl && numberEl && previewEl) {
            const sync = (source) => {
              const v = clampRadius(source.value);
              rangeEl.value = String(v);
              numberEl.value = String(v);
              setPreviewDot(previewEl, v, sel ? sel.value : e.color);
            };

            // init
            sync(rangeEl);

            rangeEl.addEventListener('input', () => sync(rangeEl));
            numberEl.addEventListener('input', () => sync(numberEl));
            if (sel) sel.addEventListener('change', () => setPreviewDot(previewEl, clampRadius(rangeEl.value), sel.value));
          }
        }
      }

      // bind delete
      tbody.querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-del');
          const idx = entries.findIndex(x => x.id === id);
          if (idx < 0) return;

          const e = entries[idx];
          if (e.marker) e.marker.remove();
          entries.splice(idx, 1);

          removeEmptyLayers();
          renderTable();
          buildLegend();
          setStatus('');
        });
      });

      // bind edit
      tbody.querySelectorAll('button[data-edit]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-edit');
          const e = entries.find(x => x.id === id);
          if (!e) return;

          e._backup = { name: e.name, address: e.address, color: e.color, radius: e.radius };
          e.isEditing = true;

          renderTable();
          setStatus('');
        });
      });

      // cancel
      tbody.querySelectorAll('button[data-cancel]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-cancel');
          const e = entries.find(x => x.id === id);
          if (!e) return;

          if (e._backup) {
            e.name = e._backup.name;
            e.address = e._backup.address;
            e.color = e._backup.color;
            e.radius = e._backup.radius;
            delete e._backup;
          }
          e.isEditing = false;

          renderTable();
          setStatus('');
        });
      });

      // save
      tbody.querySelectorAll('button[data-save]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-save');
          const e = entries.find(x => x.id === id);
          if (!e) return;

          const nameInput = tbody.querySelector(`input[data-name="${CSS.escape(id)}"]`);
          const addrInput = tbody.querySelector(`input[data-address="${CSS.escape(id)}"]`);
          const colorSel  = tbody.querySelector(`select[data-color="${CSS.escape(id)}"]`);
          const rangeEl   = tbody.querySelector(`input[data-radiusrange="${CSS.escape(id)}"]`);
          const numberEl  = tbody.querySelector(`input[data-radiusnumber="${CSS.escape(id)}"]`);

          const newName = (nameInput?.value ?? '').trim();
          const newAddress = (addrInput?.value ?? '').trim();
          const newColor = (colorSel?.value ?? e.color);
          const newRadius = clampRadius((numberEl?.value ?? rangeEl?.value ?? e.radius));

          if (!newAddress) { setStatus('Adresse må ikke være tom.'); return; }

          const oldAddress = e.address;
          const oldColor = e.color;

          e.name = newName;
          e.address = newAddress;
          e.color = newColor;
          e.radius = newRadius;

          try {
            ensureMarkerInCorrectLayer(e, oldColor);

            if (newAddress !== oldAddress) {
              const r = await geocodeAndPlaceOrMoveMarker(e, { flyTo: true });
              if (!r.ok) {
                if (e._backup) {
                  e.name = e._backup.name;
                  e.address = e._backup.address;
                  e.color = e._backup.color;
                  e.radius = e._backup.radius;
                  ensureMarkerInCorrectLayer(e, newColor);
                  updateMarkerStyleAndPopup(e);
                }
                setStatus('Kunne ikke finde adressen (ingen match).');
                e.isEditing = false;
                delete e._backup;
                renderTable();
                buildLegend();
                return;
              }
            } else {
              updateMarkerStyleAndPopup(e);
            }

            e.isEditing = false;
            delete e._backup;

            renderTable();
            buildLegend();
            setStatus('');
          } catch (err) {
            if (e._backup) {
              const wasColor = e.color;
              e.name = e._backup.name;
              e.address = e._backup.address;
              e.color = e._backup.color;
              e.radius = e._backup.radius;
              delete e._backup;
              ensureMarkerInCorrectLayer(e, wasColor);
              updateMarkerStyleAndPopup(e);
            }
            e.isEditing = false;
            renderTable();
            buildLegend();

            setStatus(
              'Kunne ikke opdatere.\n' +
              'Hvis du åbner som file://, så prøv via http://localhost (lokal server).\n\n' +
              `Fejl: ${String(err?.message || err)}`
            );
          }
        });
      });
    }

    // --------- Add: add + geocode + draw immediately ---------
    async function addEntry() {
      const btn = document.getElementById('add');
      btn.disabled = true;

      const name = document.getElementById('name').value.trim();
      const address = document.getElementById('address').value.trim();
      const color = document.getElementById('color').value;
      const radius = clampRadius(document.getElementById('radiusNumber').value);

      if (!address) {
        setStatus('Skriv en adresse før du tilføjer.');
        btn.disabled = false;
        return;
      }
      if (entries.length >= 100) {
        setStatus('Du har allerede 100 punkter i listen.');
        btn.disabled = false;
        return;
      }

      const e = { id: uuid(), name, address, color, radius, marker: null, isEditing: false };
      entries.push(e);
      renderTable();
      setStatus('');

      try {
        const r = await geocodeAndPlaceOrMoveMarker(e, { flyTo: true });
        if (!r.ok) {
          const idx = entries.findIndex(x => x.id === e.id);
          if (idx >= 0) entries.splice(idx, 1);
          renderTable();
          setStatus('Ingen match på adressen. Prøv med postnr/by.');
          btn.disabled = false;
          return;
        }

        buildLegend();
        setStatus('');

        document.getElementById('name').value = '';
        document.getElementById('address').value = '';
        document.getElementById('address').focus();
      } catch (err) {
        const idx = entries.findIndex(x => x.id === e.id);
        if (idx >= 0) entries.splice(idx, 1);
        renderTable();

        setStatus(
          'Kunne ikke hente koordinater.\n' +
          'Hvis du åbner som file://, så prøv via http://localhost (lokal server).\n\n' +
          `Fejl: ${String(err?.message || err)}`
        );
      } finally {
        btn.disabled = false;
      }
    }

    // --------- Bulk edit ---------
    function applyBulkRadius() {
      const r = clampRadius(document.getElementById('bulkRadiusNumber').value);
      if (entries.length === 0) { setStatus('Der er ingen punkter at opdatere.'); return; }

      for (const e of entries) {
        e.radius = r;
        updateMarkerStyleAndPopup(e);
      }
      renderTable();
      setStatus('');
    }

    function applyBulkColor() {
      const c = document.getElementById('bulkColor').value;
      if (entries.length === 0) { setStatus('Der er ingen punkter at opdatere.'); return; }

      for (const e of entries) {
        const oldColor = e.color;
        e.color = c;
        ensureMarkerInCorrectLayer(e, oldColor);
        updateMarkerStyleAndPopup(e);
      }
      removeEmptyLayers();
      buildLegend();
      renderTable();
      setStatus('');
    }

    // --------- Init ---------
    populateColorSelect(document.getElementById('color'), COLOR_PRESETS[0].value);
    populateColorSelect(document.getElementById('bulkColor'), COLOR_PRESETS[0].value);

    // Add form size controls sync
    const radiusRange = document.getElementById('radiusRange');
    const radiusNumber = document.getElementById('radiusNumber');
    const addPreviewDot = document.getElementById('addPreviewDot');
    const colorSelect = document.getElementById('color');

    function syncAddSizeFrom(valueSource) {
      const v = clampRadius(valueSource.value);
      radiusRange.value = String(v);
      radiusNumber.value = String(v);
      setPreviewDot(addPreviewDot, v, colorSelect.value);
    }
    radiusRange.addEventListener('input', () => syncAddSizeFrom(radiusRange));
    radiusNumber.addEventListener('input', () => syncAddSizeFrom(radiusNumber));
    colorSelect.addEventListener('change', () => setPreviewDot(addPreviewDot, clampRadius(radiusNumber.value), colorSelect.value));
    syncAddSizeFrom(radiusNumber);

    // Bulk size controls sync
    const bulkRange = document.getElementById('bulkRadiusRange');
    const bulkNumber = document.getElementById('bulkRadiusNumber');
    const bulkPreviewDot = document.getElementById('bulkPreviewDot');
    const bulkColorSelect = document.getElementById('bulkColor');

    function syncBulkSizeFrom(valueSource) {
      const v = clampRadius(valueSource.value);
      bulkRange.value = String(v);
      bulkNumber.value = String(v);
      setPreviewDot(bulkPreviewDot, v, bulkColorSelect.value);
    }
    bulkRange.addEventListener('input', () => syncBulkSizeFrom(bulkRange));
    bulkNumber.addEventListener('input', () => syncBulkSizeFrom(bulkNumber));
    bulkColorSelect.addEventListener('change', () => setPreviewDot(bulkPreviewDot, clampRadius(bulkNumber.value), bulkColorSelect.value));
    syncBulkSizeFrom(bulkNumber);

    // bind buttons
    document.getElementById('add').addEventListener('click', addEntry);
    document.getElementById('applyBulkRadius').addEventListener('click', applyBulkRadius);
    document.getElementById('applyBulkColor').addEventListener('click', applyBulkColor);

    // Enter i adressefelt = tilføj
    document.getElementById('address').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('add').click();
      }
    });

    renderTable();
  </script>
</body>
</html>
