<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Navn + adresse → Cirkler på kort (København)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root { --border:#e8e8e8; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    .wrap { display: grid; grid-template-columns: 420px 1fr; height: 100vh; }
    .panel { padding: 14px; border-right: 1px solid var(--border); overflow: auto; }
    h2 { font-size: 16px; margin: 0 0 12px; }
    label { display: block; font-size: 12px; color:#444; margin-top: 10px; }
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-sizing: border-box;
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display: grid; grid-template-columns: 1.2fr 1fr 0.8fr; gap: 10px; }
    button {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      background: #fafafa;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 10px;
    }
    button.primary { background: #111; color: #fff; border-color:#111; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .hint { font-size: 12px; color:#666; margin-top: 8px; line-height: 1.35; }
    #map { height: 100vh; }

    .list {
      margin-top: 12px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }
    .list h3 { font-size: 13px; margin: 0 0 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; font-size: 12px; padding: 8px 6px; border-bottom: 1px solid #f0f0f0; vertical-align: top; }
    th { color:#666; font-weight: 600; }
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 3px 8px; border: 1px solid #0001; border-radius: 999px;
      background: #fff;
    }
    .swatch { width: 10px; height: 10px; border-radius: 50%; border: 1px solid #0002; display:inline-block; }
    .actions { display:flex; gap:6px; }
    .mini {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }

    .legend { margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border); }
    .legend h3 { font-size: 13px; margin: 0 0 8px; }
    .legend-item { display:flex; align-items:center; gap:8px; margin: 6px 0; font-size: 12px; }
    .status { margin-top: 10px; font-size: 12px; color:#333; white-space: pre-wrap; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <h2>Tilføj punkter</h2>

      <label for="name">Navn</label>
      <input id="name" type="text" placeholder="Fx 'Kunde A' eller 'Lokation 1'"/>

      <label for="address">Adresse</label>
      <input id="address" type="text" placeholder="Fx 'Rådhuspladsen 1, 1550 København'"/>

      <div class="row3">
        <div>
          <label for="color">Farve</label>
          <select id="color"></select>
        </div>
        <div>
          <label for="radius">Størrelse (px)</label>
          <input id="radius" type="number" min="2" max="50" value="12"/>
        </div>
        <div style="display:flex; align-items:end;">
          <button id="add" class="primary" style="margin-top:0;">Tilføj</button>
        </div>
      </div>

      <label style="display:flex; align-items:center; gap:8px; margin-top: 12px;">
        <input id="limitToCph" type="checkbox" checked />
        Begræns til Københavns kommune (0101)
      </label>

      <button id="plot">Plot alle på kort</button>
      <button id="clearMarkers">Ryd markeringer (kort)</button>
      <button id="clearAll">Slet alle i listen</button>

      <div id="status" class="status"></div>

      <div class="list">
        <h3>Liste</h3>
        <div class="hint">Du kan tilføje op til ca. 100 ad gangen.</div>
        <table>
          <thead>
            <tr>
              <th style="width: 28%;">Navn</th>
              <th>Adresse</th>
              <th style="width: 18%;">Stil</th>
              <th style="width: 10%;">&nbsp;</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="4" style="color:#777;">Ingen punkter endnu.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="legend">
        <h3>Legend / filtre (kort)</h3>
        <div id="legendList" class="hint">Ingen data endnu.</div>
      </div>
    </div>

    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --------- Konfiguration ---------
    const FIXED_FILL_OPACITY = 0.55; // fast (ingen UI-kontrol)
    const CONCURRENCY = 4;           // antal samtidige geokald
    const PER_REQUEST_DELAY_MS = 80; // lille pause for at være “pæn”

    const COLOR_PRESETS = [
      { label: "Rød",   value: "#e11d48" },
      { label: "Blå",   value: "#2563eb" },
      { label: "Grøn",  value: "#16a34a" },
      { label: "Orange",value: "#f97316" },
      { label: "Lilla", value: "#7c3aed" },
      { label: "Sort",  value: "#111827" },
      { label: "Grå",   value: "#6b7280" },
    ];

    // --------- Kort ---------
    const map = L.map('map').setView([55.6761, 12.5683], 12); // København
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Layer pr. farve (nem legend/filter)
    const layersByColor = new Map(); // color -> L.LayerGroup
    function getLayer(color) {
      if (!layersByColor.has(color)) layersByColor.set(color, L.layerGroup().addTo(map));
      return layersByColor.get(color);
    }

    function clearMapMarkersOnly() {
      for (const layer of layersByColor.values()) layer.clearLayers();
      layersByColor.clear();
      document.getElementById('legendList').textContent = 'Ingen data endnu.';
    }

    // --------- UI / data ---------
    const entries = []; // {id, name, address, color, radius}

    const statusEl = document.getElementById('status');
    function setStatus(msg) { statusEl.textContent = msg || ''; }

    function escapeHtml(str) {
      return String(str ?? '').replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    function populateColorSelect() {
      const sel = document.getElementById('color');
      sel.innerHTML = '';
      for (const c of COLOR_PRESETS) {
        const opt = document.createElement('option');
        opt.value = c.value;
        opt.textContent = c.label;
        sel.appendChild(opt);
      }
      sel.value = COLOR_PRESETS[0].value;
    }

    function renderTable() {
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';

      if (entries.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" style="color:#777;">Ingen punkter endnu.</td>`;
        tbody.appendChild(tr);
        return;
      }

      for (const e of entries) {
        const tr = document.createElement('tr');

        const styleHtml = `
          <span class="pill">
            <span class="swatch" style="background:${escapeHtml(e.color)}"></span>
            ${escapeHtml(e.radius)}px
          </span>
        `;

        tr.innerHTML = `
          <td>${escapeHtml(e.name || '(uden navn)')}</td>
          <td>${escapeHtml(e.address)}</td>
          <td>${styleHtml}</td>
          <td>
            <div class="actions">
              <button class="mini" data-del="${e.id}">Slet</button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      }

      // bind delete
      tbody.querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-del');
          const idx = entries.findIndex(x => x.id === id);
          if (idx >= 0) entries.splice(idx, 1);
          renderTable();
        });
      });
    }

    // --------- DAWA geokodning ---------
    async function geocodeDAWA(address, limitToCph) {
      const params = new URLSearchParams();
      params.set('q', address);
      params.set('format', 'geojson');
      params.set('struktur', 'mini');
      params.set('srid', '4326');
      if (limitToCph) params.set('kommunekode', '0101');

      const urls = [
        `https://api.dataforsyningen.dk/adresser?${params.toString()}`,
        `https://dawa.aws.dk/adresser?${params.toString()}`
      ];

      let lastErr = null;
      for (const url of urls) {
        try {
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const geo = await res.json();
          const feat = geo && geo.features && geo.features[0];
          if (!feat) return null;
          const [lng, lat] = feat.geometry.coordinates;
          return { lat, lng };
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('Geokodning fejlede');
    }

    async function mapWithConcurrency(items, concurrency, fn) {
      const results = new Array(items.length);
      let idx = 0;

      async function worker() {
        while (idx < items.length) {
          const my = idx++;
          results[my] = await fn(items[my], my);
        }
      }

      const workers = [];
      for (let i = 0; i < Math.min(concurrency, items.length); i++) workers.push(worker());
      await Promise.all(workers);
      return results;
    }

    // --------- Legend / filtre ---------
    function buildLegend() {
      const legendEl = document.getElementById('legendList');
      legendEl.innerHTML = '';

      if (layersByColor.size === 0) {
        legendEl.textContent = 'Ingen data endnu.';
        return;
      }

      for (const [color, layer] of layersByColor.entries()) {
        const id = 'chk_' + btoa(color).replace(/=/g,'');
        const row = document.createElement('div');
        row.className = 'legend-item';

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.id = id;
        chk.checked = map.hasLayer(layer);
        chk.addEventListener('change', () => {
          if (chk.checked) layer.addTo(map);
          else map.removeLayer(layer);
        });

        const sw = document.createElement('span');
        sw.className = 'swatch';
        sw.style.background = color;

        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = color;

        row.appendChild(chk);
        row.appendChild(sw);
        row.appendChild(label);
        legendEl.appendChild(row);
      }
    }

    // --------- Handlers ---------
    document.getElementById('add').addEventListener('click', () => {
      const name = document.getElementById('name').value.trim();
      const address = document.getElementById('address').value.trim();
      const color = document.getElementById('color').value;
      const radius = Math.max(2, Math.min(50, parseInt(document.getElementById('radius').value, 10) || 12));

      if (!address) {
        setStatus('Skriv en adresse før du tilføjer.');
        return;
      }
      if (entries.length >= 100) {
        setStatus('Du har allerede 100 punkter i listen. Slet nogle eller lav en ny omgang.');
        return;
      }

      entries.push({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        name,
        address,
        color,
        radius
      });

      // ryd felter (navn beholdes ofte? jeg rydder begge – nemt at ændre)
      document.getElementById('name').value = '';
      document.getElementById('address').value = '';
      document.getElementById('address').focus();

      setStatus('');
      renderTable();
    });

    document.getElementById('plot').addEventListener('click', async () => {
      const btn = document.getElementById('plot');
      btn.disabled = true;

      try {
        clearMapMarkersOnly();

        if (entries.length === 0) {
          setStatus('Tilføj mindst ét punkt i listen først.');
          return;
        }

        const limitToCph = document.getElementById('limitToCph').checked;

        setStatus(`Geokoder ${entries.length} adresser…`);

        const results = await mapWithConcurrency(entries, CONCURRENCY, async (e) => {
          await new Promise(r => setTimeout(r, PER_REQUEST_DELAY_MS));
          try {
            const g = await geocodeDAWA(e.address, limitToCph);
            if (!g) return { ok:false, entry:e, error:'Ingen match' };
            return { ok:true, entry:e, lat:g.lat, lng:g.lng };
          } catch (err) {
            return { ok:false, entry:e, error: String(err?.message || err) };
          }
        });

        let okCount = 0, failCount = 0;
        const bounds = [];

        for (const r of results) {
          if (!r.ok) { failCount++; continue; }
          okCount++;

          const e = r.entry;
          const layer = getLayer(e.color);

          const popup = `
            <div style="line-height:1.3">
              <b>${escapeHtml(e.name || '(uden navn)')}</b><br/>
              ${escapeHtml(e.address)}<br/>
              <span style="color:#666">${escapeHtml(e.color)}, ${escapeHtml(e.radius)}px</span>
            </div>
          `;

          L.circleMarker([r.lat, r.lng], {
            radius: e.radius,
            color: e.color,
            fillColor: e.color,
            fillOpacity: FIXED_FILL_OPACITY,
            weight: 1
          }).bindPopup(popup).addTo(layer);

          bounds.push([r.lat, r.lng]);
        }

        buildLegend();

        if (bounds.length) map.fitBounds(bounds, { padding: [30, 30] });

        let msg = `Færdig ✅\nMatchede: ${okCount}\nFejl/ingen match: ${failCount}\n`;
        const failed = results.filter(x => !x.ok).slice(0, 12);
        if (failed.length) {
          msg += `\nFørste ${failed.length} fejl:\n`;
          for (const f of failed) {
            const n = f.entry?.name ? `${f.entry.name} — ` : '';
            msg += `- ${n}${f.entry.address}: ${f.error}\n`;
          }
        }
        setStatus(msg);

      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('clearMarkers').addEventListener('click', () => {
      clearMapMarkersOnly();
      setStatus('Ryddede markeringer på kortet.');
    });

    document.getElementById('clearAll').addEventListener('click', () => {
      entries.splice(0, entries.length);
      clearMapMarkersOnly();
      renderTable();
      setStatus('Slettede alle punkter i listen.');
    });

    // Init
    populateColorSelect();
    renderTable();

    // Enter i adressefelt = tilføj
    document.getElementById('address').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('add').click();
      }
    });
  </script>
</body>
</html>
