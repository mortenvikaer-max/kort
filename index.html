<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tilføj valgsteder</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root { --border:#e8e8e8; --sidebar: 420px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }

    .wrap { display: grid; grid-template-columns: var(--sidebar) 10px 1fr; height: 100vh; }
    .panel { padding: 14px; border-right: 1px solid var(--border); overflow: auto; overflow-x: hidden; }

    .resizer {
      cursor: col-resize;
      background: linear-gradient(to right, #0000, #0001, #0000);
      border-right: 1px solid var(--border);
      border-left: 1px solid var(--border);
    }
    .resizer:hover { background: linear-gradient(to right, #0000, #0002, #0000); }

    h2 { font-size: 16px; margin: 0 0 12px; }
    label { display: block; font-size: 12px; color:#444; margin-top: 10px; }

    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      background: #fafafa;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 10px;
      box-sizing: border-box;
    }
    button.primary { background: #111; color: #fff; border-color:#111; }
    button:disabled { opacity: .6; cursor: not-allowed; }

    .hint { font-size: 12px; color:#666; margin-top: 8px; line-height: 1.35; }
    #map { height: 100vh; }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .status { margin-top: 10px; font-size: 12px; color:#333; white-space: pre-wrap; }

    /* Prevent overflow */
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td {
      text-align: left; font-size: 12px; padding: 8px 6px;
      border-bottom: 1px solid #f0f0f0; vertical-align: top;
      overflow-wrap: anywhere;
    }
    th { color:#666; font-weight: 600; }

    /* IMPORTANT: wrap actions so they never overflow */
    .actions { display:flex; gap:6px; flex-wrap: wrap; align-items:center; }
    .mini {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      width: auto;
      margin-top: 0;
      white-space: nowrap;
      max-width: 100%;
      box-sizing: border-box;
    }
    .mini.primary { background:#111; color:#fff; border-color:#111; }

    .section { margin-top: 12px; border-top: 1px solid var(--border); padding-top: 10px; }

    details {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      padding: 8px 10px;
      margin-top: 10px;
    }
    summary {
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #333;
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    summary::-webkit-details-marker { display: none; }
    .summaryRight { font-size: 12px; color:#666; font-weight: 500; }

    .filterBtns { display:flex; gap:6px; margin-top: 8px; flex-wrap: wrap; }
    .filterGrid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 10px; margin-top: 10px; }
    .filterItem { display:flex; align-items:center; gap:8px; font-size:12px; }
    .filterItem input { transform: translateY(1px); }

    .inlineInput { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 12px; }
    .inlineSelect { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 12px; background: #fff; }
    .inlineNumber { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 12px; }

    .controlsRow { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    @media (max-width: 420px) {
      .filterGrid { grid-template-columns: repeat(1, minmax(0, 1fr)); }
    }

    /* Tabs */
    .tabs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 0 0 12px;
    }
    .tabBtn {
      margin-top: 0;
      border-radius: 12px;
      padding: 10px;
      font-weight: 600;
      background: #fff;
    }
    .tabBtn.active {
      background: #111;
      color: #fff;
      border-color:#111;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">

      <div class="tabs">
        <button id="tabValg" class="tabBtn active" type="button">Valgsteder</button>
        <button id="tabBrev" class="tabBtn" type="button">Brevstemmesteder</button>
      </div>

      <h2 id="pageTitle">Tilføj valgsteder</h2>

      <label for="kreds">Kreds</label>
      <select id="kreds"></select>

      <label for="name">Navn</label>
      <input id="name" type="text" placeholder="f.eks. 1. Nord, Strandvejsskolen"/>

      <label for="address">Adresse</label>
      <input id="address" type="text" placeholder="Fx 'Rådhuspladsen 1, 1550 København'"/>

      <div class="row2">
        <div>
          <label for="color">Farve</label>
          <select id="color"></select>
        </div>
        <div>
          <label for="radiusNumber">Størrelse (px) (max 20)</label>
          <input id="radiusNumber" type="number" min="2" max="20" value="12" />
        </div>
      </div>

      <button id="add" class="primary" type="button">Tilføj</button>

      <div id="status" class="status"></div>

      <div class="section">
        <details open>
          <summary>
            Filtre
            <span class="summaryRight" id="filterSummary"></span>
          </summary>

          <details open>
            <summary>
              Kredse / kategorier
              <span class="summaryRight" id="kredsSummary"></span>
            </summary>
            <div class="filterBtns">
              <button class="mini" id="kredsAll" type="button">Vælg alle</button>
              <button class="mini" id="kredsNone" type="button">Fjern alle</button>
            </div>
            <div class="filterGrid" id="kredsFilters"></div>
          </details>
        </details>
      </div>

      <div class="section">
        <details open>
          <summary>
            <span id="listTitle">Valgsteder fordelt på kreds</span>
            <span class="summaryRight" id="listSummary"></span>
          </summary>
          <div id="kredsLists"></div>
        </details>
      </div>

      <div class="section">
        <details>
          <summary>
            <span id="bulkTitle">Ændringer for alle valgsteder</span>
            <span class="summaryRight" id="bulkSummary"></span>
          </summary>

          <!-- Segmentering: alle eller én farve -->
          <label for="bulkTargetColor" style="margin-top:10px;">Gælder for (farve)</label>
          <select id="bulkTargetColor"></select>
          <div class="hint" id="bulkTargetHint"></div>

          <div class="row2" style="margin-top:10px;">
            <div>
              <label for="bulkRadiusNumber">Sæt størrelse (px) (max 20)</label>
              <input id="bulkRadiusNumber" type="number" min="2" max="20" value="12" />
              <button id="applyBulkRadius" class="mini primary" type="button" style="margin-top:8px;">Anvend størrelse</button>
            </div>

            <div>
              <label for="bulkColor">Skift farve til</label>
              <select id="bulkColor"></select>
              <button id="applyBulkColor" class="mini" type="button" style="margin-top:8px;">Anvend farveskift</button>
            </div>
          </div>

          <label for="bulkOpacityNumber" style="margin-top:12px;">Opacity (0–1)</label>
          <div class="controlsRow">
            <input id="bulkOpacityRange" type="range" min="0" max="1" step="0.05" value="0.55" />
            <input id="bulkOpacityNumber" type="number" min="0" max="1" step="0.05" value="0.55" />
          </div>
          <div class="hint">Opacity gemmes automatisk. (Gælder for den valgte farve – eller alle farver).</div>

          <button id="clearAllStorage" class="mini" type="button" style="margin-top:12px;">Slet alle gemte steder</button>
          <div class="hint">Dette fjerner alt gemt i browseren (localStorage) for den valgte fane.</div>
        </details>
      </div>

    </div>

    <div id="resizer" class="resizer" title="Træk for at ændre menu-bredde"></div>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ----------------- Konfiguration -----------------
    const PER_REQUEST_DELAY_MS = 80;
    const LIMIT_TO_CPH = true; // geokodning begrænses i baggrunden til kommunekode 0101

    // UI
    const UI_KEY = "valgsteder_ui_sidebar_v1";

    // Datasæt keys (hver fane gemmes separat)
    const STORAGE_KEYS = {
      valg: "valgsteder_state_v6",
      brev: "brevsteder_state_v1"
    };
    const SEED_KEYS = {
      valg: "valgsteder_seed_v2",
      brev: "brevsteder_seed_v1"
    };

    const NEIGHBOR_STYLE = { color: "#2f2f2f", weight: 1, fillColor: "#2f2f2f", fillOpacity: 0.35 };
    const CPH_OUTLINE_STYLE = { color: "#e11d48", weight: 1, fillOpacity: 0 };

    const COLOR_PRESETS = [
      { label: "Rød",   value: "#e11d48" },
      { label: "Blå",   value: "#2563eb" },
      { label: "Grøn",  value: "#16a34a" },
      { label: "Orange",value: "#f97316" },
      { label: "Lilla", value: "#7c3aed" },
      { label: "Sort",  value: "#111827" },
      { label: "Grå",   value: "#6b7280" },
    ];
    const COLOR_LABEL_BY_VALUE = Object.fromEntries(COLOR_PRESETS.map(c => [c.value, c.label]));

    // Kreds/kategorier
    const KREDS_OPTIONS = [
      ...Array.from({ length: 9 }, (_, i) => ({ key: String(i + 1), label: `${i + 1}. kreds` })),
      { key: "new",    label: "Nyt sted" },
      { key: "closed", label: "Nedlagt sted" }
    ];
    const KREDS_LABEL_BY_KEY = Object.fromEntries(KREDS_OPTIONS.map(o => [o.key, o.label]));

    // --------- FORUDINDSATTE VALGSTEDER (kun Valgsteder-fanen) ---------
    const DEFAULT_VALGSTEDER = [
      // 1. kreds
      { kredsKey:"1", name:"1. Nord. Strandvejsskolen", address:"Sionsgade 1" },
      { kredsKey:"1", name:"1. Nordhavn. Østerbrohuset", address:"Århusgade 103" },
      { kredsKey:"1", name:"1. Nordvest. Kildevældskolen", address:"Bellmansgade 5A" },
      { kredsKey:"1", name:"1. Syd. Remisen", address:"Blegdamsvej 132" },
      { kredsKey:"1", name:"1. Vest. Nørre Fælled Skole", address:"Biskop Krags Vænge 7" },
      { kredsKey:"1", name:"1. Øst. Skolen På Strandboulevarden", address:"Strandboulevarden 47" },
      { kredsKey:"1", name:"1. Østerbro. Idrætshuset", address:"Gunnar Nu Hansens Plads 7" },

      // 2. kreds
      { kredsKey:"2", name:"2. Kalvebod Fælled", address:"Else Alfelts Vej 2" },
      { kredsKey:"2", name:"2. Nord. Amager Fælled Skole", address:"Sundholmsvej 2A" },
      { kredsKey:"2", name:"2. Peder Lykke. Peder Lykke Skolen", address:"Birketinget 3" },
      { kredsKey:"2", name:"2. Sundbyvester. Sundby Idrætspark", address:"Englandsvej 61" },
      { kredsKey:"2", name:"2. Ørestad. Ørestad Gymnasium", address:"Arne Jacobsens Allé 21" },
      { kredsKey:"2", name:"2. Vest. Skolen På Islands Brygge", address:"Artillerivej 57" },
      { kredsKey:"2", name:"2. Øst. Dyvekeskolen", address:"Remisevej 16" },

      // 3. kreds
      { kredsKey:"3", name:"3. Indre By. Rådhushallen", address:"Rådhuspladsen 1" },
      { kredsKey:"3", name:"3. Midt. Den Classenske Legatskole", address:"Vester Voldgade 98" },
      { kredsKey:"3", name:"3. Nord. Øster Farimagsgade Skole", address:"Øster Farimagsgade 40" },
      { kredsKey:"3", name:"3. Syd. Hal C", address:"Arsenalvej 6" },
      { kredsKey:"3", name:"3. Sølvgade. Sølvgades Skole", address:"Sølvgade 16" },
      { kredsKey:"3", name:"3. Øst. Nyboder Skole", address:"Øster Voldgade 15" },

      // 4. kreds
      { kredsKey:"4", name:"4. Nord. Skolen På Amagerbro", address:"Lybækgade 20" },
      { kredsKey:"4", name:"4. Nordøst. Nordøstamager Skole", address:"Holmbladsgade 117" },
      { kredsKey:"4", name:"4. Sundbyøster. Lergravsparkens Skole", address:"Wittenberggade 2" },
      { kredsKey:"4", name:"4. Syd. Gerbrandskolen", address:"Gerbrandsvej 9" },
      { kredsKey:"4", name:"4. Øst. Skolen Ved Sundet", address:"Samosvej 50" },

      // 5. kreds
      { kredsKey:"5", name:"5. Nord. Rådmandsgades Skole", address:"Rådmandsgade 22" },
      { kredsKey:"5", name:"5. Nordvest. Frederiksgård Skole", address:"Ørholmgade 8" },
      { kredsKey:"5", name:"5. Nørrebro. Guldberg Skole", address:"Sjællandsgade 10" },
      { kredsKey:"5", name:"5. Nørrebrohallen. Nørrebrohallen", address:"Nørrebrogade 208" },
      { kredsKey:"5", name:"5. Syd. Korsgadehallen", address:"Korsgade 29" },
      { kredsKey:"5", name:"5. Vest. Nørrebro Park Skole", address:"Jagtvej 34" },
      { kredsKey:"5", name:"5. Øst. Plejecentret Sølund", address:"Ryesgade 20A" },

      // 6. kreds
      { kredsKey:"6", name:"6. Bispebjerg. Tagensbo Skole", address:"Hovmestervej 19" },
      { kredsKey:"6", name:"6. Nord. Holbergskolen", address:"Frederiksborgvej 216" },
      { kredsKey:"6", name:"6. Syd. Grøndalsvængets Skole", address:"Rørsangervej 29" },
      { kredsKey:"6", name:"6. Vest. Utterslev Skole", address:"Skoleholdervej 20" },
      { kredsKey:"6", name:"6. Øst. Lundehusskolen", address:"Lersø Parkallé 152" },

      // 7. kreds
      { kredsKey:"7", name:"7. Kirkebjerg. Kirkebjerg Skole", address:"Vanløsehøj 4" },
      { kredsKey:"7", name:"7. Nord. Tingbjerg Skole", address:"Skolesiden 2" },
      { kredsKey:"7", name:"7. Nordvest. Husum Skole", address:"Karlslundevej 23" },
      { kredsKey:"7", name:"7. Rødkilde. Rødkilde Skole", address:"Godthåbsvej 274" },
      { kredsKey:"7", name:"7. Vanløse. Vanløsehallerne", address:"Hirtshalsvej 6C" },
      { kredsKey:"7", name:"7. Vest. Energicenter Voldparken", address:"Kobbelvænget 65" },
      { kredsKey:"7", name:"7. Øst. Bellahøj Skole", address:"Svenskelejren 18" },

      // 8. kreds
      { kredsKey:"8", name:"8. Midt. Vigerslev Allés Skole", address:"Vigerslev Allé 108" },
      { kredsKey:"8", name:"8. Nord. Prøvehallen", address:"Porcelænstorvet 4" },
      { kredsKey:"8", name:"8. Syd. Kirsebærhavens Skole", address:"Kirsebærhaven 23" },
      { kredsKey:"8", name:"8. Sydøst. Sankt Annæ Gymnasium", address:"Sjælør Boulevard 135" },
      { kredsKey:"8", name:"8. Valby. Ålholm Skole", address:"Vibeholmen 1" },
      { kredsKey:"8", name:"8. Vest. Lykkebo Hallen", address:"Lykkebovej 30" },

      // 9. kreds
      { kredsKey:"9", name:"9. Midt. Bavnehøjhallen", address:"Enghavevej 90" },
      { kredsKey:"9", name:"9. Nord. Oehlenschlægersgades Skole", address:"Oehlenschlægersgade 57" },
      { kredsKey:"9", name:"9. Sluseholmen. Sluseholmen Skole", address:"Ved Stigbordene 26" },
      { kredsKey:"9", name:"9. Syd. Ellebjerg Skole", address:"P. Knudsens Gade 37" },
      { kredsKey:"9", name:"9. Sydhavn. Skolen I Sydhavnen", address:"Støberigade 1" },
      { kredsKey:"9", name:"9. Vest. Vesterbro Ny Skole", address:"Slesvigsgade 6" },
      { kredsKey:"9", name:"9. Vesterbro. Tove Ditlevsens Skole", address:"Enghave Plads 21" },
      { kredsKey:"9", name:"9. Øst. Skolen Ved Dybbølsbro", address:"Kødboderne 8" },
    ];

    const DEFAULT_SEED_STYLE = { color: "#e11d48", radius: 6 };

    // ----------------- Kort -----------------
    const map = L.map('map').setView([55.6761, 12.5683], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Naboer (grå) under markører
    map.createPane('neighborsPane');
    map.getPane('neighborsPane').style.zIndex = 430;
    map.getPane('neighborsPane').style.pointerEvents = 'none';

    // København-outline (rød) under markører
    map.createPane('cphOutlinePane');
    map.getPane('cphOutlinePane').style.zIndex = 440;
    map.getPane('cphOutlinePane').style.pointerEvents = 'none';

    // Markører øverst og klikbare
    map.createPane('markersPane');
    map.getPane('markersPane').style.zIndex = 650;
    map.getPane('markersPane').style.pointerEvents = 'auto';

    // Separat layerGroup pr. fane (så vi kan skifte “kort” via faner)
    const groupValg = L.layerGroup().addTo(map);
    const groupBrev = L.layerGroup(); // først tilføjet når fanen vælges

    // ----------------- Utils -----------------
    function escapeHtml(str) {
      return String(str ?? '').replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }
    function uuid() {
      return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random());
    }
    function clampRadius(v) {
      const n = Number(v);
      if (!Number.isFinite(n)) return 12;
      return Math.max(2, Math.min(20, Math.round(n)));
    }
    function clampOpacity(v, fallback) {
      const n = Number(v);
      if (!Number.isFinite(n)) return fallback;
      return Math.max(0, Math.min(1, Math.round(n * 20) / 20));
    }

    function populateColorSelect(selectEl, defaultValue) {
      selectEl.innerHTML = '';
      for (const c of COLOR_PRESETS) {
        const opt = document.createElement('option');
        opt.value = c.value;
        opt.textContent = c.label;
        selectEl.appendChild(opt);
      }
      selectEl.value = defaultValue || COLOR_PRESETS[0].value;
    }

    function populateKredsSelect(selectEl, defaultKey) {
      selectEl.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'Vælg…';
      selectEl.appendChild(opt0);

      for (const o of KREDS_OPTIONS) {
        const opt = document.createElement('option');
        opt.value = o.key;
        opt.textContent = o.label;
        selectEl.appendChild(opt);
      }
      selectEl.value = defaultKey ?? '';
    }

    // ----------------- DAWA geokodning -----------------
    async function geocodeDAWA(address) {
      const params = new URLSearchParams();
      params.set('q', address);
      params.set('format', 'geojson');
      params.set('struktur', 'mini');
      params.set('srid', '4326');
      if (LIMIT_TO_CPH) params.set('kommunekode', '0101');

      const urls = [
        `https://api.dataforsyningen.dk/adresser?${params.toString()}`,
        `https://dawa.aws.dk/adresser?${params.toString()}`
      ];

      let lastErr = null;
      for (const url of urls) {
        try {
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const geo = await res.json();
          const feat = geo && geo.features && geo.features[0];
          if (!feat) return null;
          const [lng, lat] = feat.geometry.coordinates;
          return { lat, lng };
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('Geokodning fejlede');
    }

    // ----------------- Kommune-overlay -----------------
    function collectRoundedCoordKeys(geometry, decimals = 6) {
      const out = [];
      const round = (x) => Number(x).toFixed(decimals);
      function pushPoint(pt) {
        if (!pt || pt.length < 2) return;
        out.push(`${round(pt[0])},${round(pt[1])}`);
      }
      if (!geometry) return out;

      if (geometry.type === "Polygon") {
        for (const ring of geometry.coordinates || []) for (const pt of ring || []) pushPoint(pt);
      } else if (geometry.type === "MultiPolygon") {
        for (const poly of geometry.coordinates || []) {
          for (const ring of poly || []) for (const pt of ring || []) pushPoint(pt);
        }
      }
      return out;
    }

    async function addCphRing2Overlay() {
      try {
        const url = "https://api.dataforsyningen.dk/kommuner/?format=geojson";
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const geo = await res.json();
        const feats = geo.features || [];

        const getCode = (f) => String((f.properties || {}).kode || "");
        const cph = feats.find(f => getCode(f) === "0101") || feats.find(f => /københavn/i.test(String((f.properties||{}).navn||"")));
        if (!cph) return;

        const keyToCodes = new Map();
        const codeToFeature = new Map();

        for (const f of feats) {
          const code = getCode(f);
          if (!code) continue;
          codeToFeature.set(code, f);

          const keys = collectRoundedCoordKeys(f.geometry, 6);
          for (const k of keys) {
            let s = keyToCodes.get(k);
            if (!s) { s = new Set(); keyToCodes.set(k, s); }
            s.add(code);
          }
        }

        const adjacency = new Map();
        for (const [, codesSet] of keyToCodes.entries()) {
          const codes = Array.from(codesSet);
          if (codes.length < 2) continue;
          for (let i=0;i<codes.length;i++) {
            for (let j=i+1;j<codes.length;j++) {
              const a = codes[i], b = codes[j];
              if (!adjacency.has(a)) adjacency.set(a, new Set());
              if (!adjacency.has(b)) adjacency.set(b, new Set());
              adjacency.get(a).add(b);
              adjacency.get(b).add(a);
            }
          }
        }

        const start = "0101";
        const depth = new Map([[start, 0]]);
        const q = [start];

        while (q.length) {
          const cur = q.shift();
          const d = depth.get(cur);
          if (d >= 2) continue;
          const neigh = adjacency.get(cur) || new Set();
          for (const n of neigh) {
            if (!depth.has(n)) { depth.set(n, d + 1); q.push(n); }
          }
        }

        const grayCodes = new Set();
        for (const [code, d] of depth.entries()) {
          if (code === start) continue;
          if (d === 1 || d === 2) grayCodes.add(code);
        }
        grayCodes.add("0147"); // Frederiksberg

        const grayFeatures = [];
        for (const code of grayCodes) {
          const f = codeToFeature.get(code);
          if (f) grayFeatures.push(f);
        }

        if (grayFeatures.length) {
          L.geoJSON({ type: "FeatureCollection", features: grayFeatures }, {
            pane: "neighborsPane",
            style: () => NEIGHBOR_STYLE
          }).addTo(map);
        }

        const cphOutline = L.geoJSON(cph, {
          pane: "cphOutlinePane",
          style: () => CPH_OUTLINE_STYLE
        }).addTo(map);
        cphOutline.bringToFront();

      } catch (e) {
        console.warn("Kunne ikke indlæse kommune-overlays:", e);
      }
    }

    // ----------------- Datasæt (faner) -----------------
    function createDataset(id, layerGroup) {
      return {
        id,
        layerGroup,
        entries: [],
        selectedKredse: new Set(KREDS_OPTIONS.map(o => o.key)),
        defaultOpacity: 0.55,
        markerById: new Map(),
        editingIds: new Set(),
        backups: new Map(),
        statusMsg: "",
        loaded: false,
        geocoding: false
      };
    }

    const datasets = {
      valg: createDataset("valg", groupValg),
      brev: createDataset("brev", groupBrev)
    };

    let activeId = "valg";
    function active() { return datasets[activeId]; }

    const statusEl = document.getElementById('status');
    function setStatus(msg) {
      active().statusMsg = msg || "";
      statusEl.textContent = active().statusMsg;
    }
    function refreshStatus() {
      statusEl.textContent = active().statusMsg || "";
    }

    function markerPopupHtml(e) {
      return `
        <div style="line-height:1.3">
          <b>${escapeHtml(e.name || '(uden navn)')}</b><br/>
          ${escapeHtml(e.address || '')}
        </div>
      `;
    }

    function ensureMarker(ds, e) {
      let m = ds.markerById.get(e.id);
      const op = (typeof e.opacity === "number") ? e.opacity : ds.defaultOpacity;

      if (!m && Number.isFinite(e.lat) && Number.isFinite(e.lng)) {
        m = L.circleMarker([e.lat, e.lng], {
          pane: 'markersPane',
          radius: e.radius,
          color: e.color,
          fillColor: e.color,
          fillOpacity: op,
          weight: 1,
          interactive: true
        }).bindPopup(markerPopupHtml(e));

        m.on('click', () => m.openPopup());

        ds.markerById.set(e.id, m);
      }
      return m || null;
    }

    function updateMarkerStyleAndPopup(ds, e) {
      const m = ds.markerById.get(e.id);
      if (!m) return;

      const op = (typeof e.opacity === "number") ? e.opacity : ds.defaultOpacity;
      m.setStyle({ color: e.color, fillColor: e.color, fillOpacity: op, weight: 1 });
      m.setRadius(e.radius);
      m.bindPopup(markerPopupHtml(e));
    }

    function isEntryVisible(ds, e) {
      return ds.selectedKredse.has(e.kredsKey);
    }

    function updateVisibility(ds) {
      for (const e of ds.entries) {
        const m = ensureMarker(ds, e);
        if (!m) continue;

        const vis = isEntryVisible(ds, e);
        if (vis) {
          if (!ds.layerGroup.hasLayer(m)) ds.layerGroup.addLayer(m);
        } else {
          if (ds.layerGroup.hasLayer(m)) ds.layerGroup.removeLayer(m);
        }
      }
      updateSummaries(ds);
    }

    // ----------------- Persistence -----------------
    function saveState(ds) {
      const state = {
        version: 1,
        defaultOpacity: ds.defaultOpacity,
        selectedKredse: [...ds.selectedKredse],
        entries: ds.entries.map(e => ({
          id: e.id,
          kredsKey: e.kredsKey,
          name: e.name,
          address: e.address,
          color: e.color,
          radius: e.radius,
          opacity: (typeof e.opacity === "number") ? e.opacity : ds.defaultOpacity,
          lat: e.lat,
          lng: e.lng
        }))
      };
      try { localStorage.setItem(STORAGE_KEYS[ds.id], JSON.stringify(state)); } catch {}
      updateBulkSummary(ds);
    }

    function loadState(ds) {
      if (ds.loaded) return;
      ds.loaded = true;

      try {
        const raw = localStorage.getItem(STORAGE_KEYS[ds.id]);
        if (!raw) return;
        const s = JSON.parse(raw);
        if (!s || !Array.isArray(s.entries)) return;

        ds.defaultOpacity = clampOpacity(s.defaultOpacity ?? 0.55, 0.55);

        ds.selectedKredse.clear();
        const defaults = KREDS_OPTIONS.map(o => o.key);
        for (const k of (s.selectedKredse ?? defaults)) ds.selectedKredse.add(String(k));

        ds.entries.splice(0, ds.entries.length);
        for (const e of s.entries) {
          const kredsKey = String(e.kredsKey ?? "");
          ds.entries.push({
            id: e.id || uuid(),
            kredsKey: KREDS_LABEL_BY_KEY[kredsKey] ? kredsKey : "1",
            name: e.name || "",
            address: e.address || "",
            color: e.color || COLOR_PRESETS[0].value,
            radius: clampRadius(e.radius ?? 12),
            opacity: clampOpacity(e.opacity ?? ds.defaultOpacity, ds.defaultOpacity),
            lat: (typeof e.lat === "number" ? e.lat : undefined),
            lng: (typeof e.lng === "number" ? e.lng : undefined),
          });
        }
      } catch {}
    }

    function clearStorage(ds) {
      try { localStorage.removeItem(STORAGE_KEYS[ds.id]); } catch {}
      try { localStorage.removeItem(SEED_KEYS[ds.id]); } catch {}
    }

    // ----------------- Seed (kun Valgsteder) -----------------
    function hasSeeded(ds) {
      try { return localStorage.getItem(SEED_KEYS[ds.id]) === "1"; } catch { return false; }
    }
    function markSeeded(ds) {
      try { localStorage.setItem(SEED_KEYS[ds.id], "1"); } catch {}
    }

    function seedDefaultIfNeeded(ds) {
      if (ds.id !== "valg") return false;
      if (ds.entries.length > 0) return false;
      if (hasSeeded(ds)) return false;

      for (const v of DEFAULT_VALGSTEDER) {
        ds.entries.push({
          id: uuid(),
          kredsKey: v.kredsKey,
          name: v.name,
          address: v.address,
          color: DEFAULT_SEED_STYLE.color,
          radius: DEFAULT_SEED_STYLE.radius,
          opacity: ds.defaultOpacity,
          lat: undefined,
          lng: undefined
        });
      }
      markSeeded(ds);
      saveState(ds);
      return true;
    }

    // ----------------- Geocode -----------------
    async function geocodeAndSetCoords(ds, e, { flyTo = false } = {}) {
      await new Promise(r => setTimeout(r, PER_REQUEST_DELAY_MS));
      const g = await geocodeDAWA(e.address);
      if (!g) return { ok:false, error:"Ingen match" };
      e.lat = g.lat; e.lng = g.lng;

      const m = ensureMarker(ds, e);
      if (m) {
        m.setLatLng([e.lat, e.lng]);
        updateMarkerStyleAndPopup(ds, e);
      }
      updateVisibility(ds);

      if (flyTo) map.setView([e.lat, e.lng], Math.max(map.getZoom(), 14));
      return { ok:true };
    }

    async function geocodeAllMissing(ds) {
      if (ds.geocoding) return;
      const pending = ds.entries.filter(e => !(Number.isFinite(e.lat) && Number.isFinite(e.lng)));
      if (!pending.length) return;

      ds.geocoding = true;
      const failed = [];

      for (let i = 0; i < pending.length; i++) {
        const e = pending[i];
        try {
          const r = await geocodeAndSetCoords(ds, e, { flyTo: false });
          if (!r.ok) failed.push({ name: e.name, address: e.address, error: r.error || "Ingen match" });
        } catch (err) {
          failed.push({ name: e.name, address: e.address, error: String(err?.message || err) });
        }
        saveState(ds);
      }

      renderKredsLists(ds);
      updateVisibility(ds);

      // Vis kun fejl
      if (failed.length) {
        let msg = `Disse adresser kunne ikke geokodes (ret dem manuelt):\n`;
        for (const f of failed) msg += `- ${f.name}: ${f.address} (${f.error})\n`;
        ds.statusMsg = msg;
      } else {
        ds.statusMsg = "";
      }
      if (active().id === ds.id) refreshStatus();
      ds.geocoding = false;
    }

    // ----------------- Bulk UI -----------------
    function populateBulkTargetColor() {
      const sel = document.getElementById('bulkTargetColor');
      sel.innerHTML = '';

      const all = document.createElement('option');
      all.value = "__all__";
      all.textContent = "Alle farver";
      sel.appendChild(all);

      for (const c of COLOR_PRESETS) {
        const opt = document.createElement('option');
        opt.value = c.value;
        opt.textContent = c.label;
        sel.appendChild(opt);
      }
      sel.value = "__all__";
      updateBulkTargetHint(active());
      updateBulkSummary(active());
    }

    function getBulkTargets(ds) {
      const target = document.getElementById('bulkTargetColor').value;
      if (target === "__all__") return ds.entries.slice();
      return ds.entries.filter(e => e.color === target);
    }

    function updateBulkTargetHint(ds) {
      const target = document.getElementById('bulkTargetColor').value;
      const hintEl = document.getElementById('bulkTargetHint');
      if (target === "__all__") hintEl.textContent = "Ændringerne påvirker alle farver.";
      else hintEl.textContent = `Ændringerne påvirker kun "${COLOR_LABEL_BY_VALUE[target] || target}".`;
      updateBulkSummary(ds);
    }

    function updateBulkSummary(ds) {
      const total = ds.entries.length;
      const count = getBulkTargets(ds).length;
      document.getElementById('bulkSummary').textContent = total ? `${count}/${total}` : '';
    }

    // ----------------- Filters + List UI -----------------
    function renderKredsFilters(ds) {
      const container = document.getElementById('kredsFilters');
      container.innerHTML = '';

      for (const o of KREDS_OPTIONS) {
        const id = `k_${o.key}`;
        const lab = document.createElement('label');
        lab.className = 'filterItem';
        lab.innerHTML = `
          <input type="checkbox" id="${id}" ${ds.selectedKredse.has(o.key) ? 'checked' : ''}/>
          <span>${escapeHtml(o.label)}</span>
        `;
        container.appendChild(lab);

        lab.querySelector('input').addEventListener('change', (ev) => {
          if (ev.target.checked) ds.selectedKredse.add(o.key);
          else ds.selectedKredse.delete(o.key);
          updateVisibility(ds);
          saveState(ds);
          renderKredsSummaries(ds);
          renderKredsLists(ds);
        });
      }
      renderKredsSummaries(ds);
    }

    function setAllKredse(ds, on) {
      ds.selectedKredse.clear();
      if (on) for (const o of KREDS_OPTIONS) ds.selectedKredse.add(o.key);
      renderKredsFilters(ds);
      updateVisibility(ds);
      saveState(ds);
      renderKredsLists(ds);
    }

    function renderKredsSummaries(ds) {
      document.getElementById('kredsSummary').textContent = `${ds.selectedKredse.size}/${KREDS_OPTIONS.length} valgt`;
    }

    function updateSummaries(ds) {
      const visible = ds.entries.filter(e => isEntryVisible(ds, e)).length;
      document.getElementById('filterSummary').textContent = `${visible}/${ds.entries.length} vises`;
      document.getElementById('listSummary').textContent = `${ds.entries.length} total`;
      renderKredsSummaries(ds);
      updateBulkSummary(ds);
    }

    function groupEntriesByKredsKey(ds) {
      const byK = new Map();
      for (const o of KREDS_OPTIONS) byK.set(o.key, []);
      for (const e of ds.entries) {
        const k = byK.has(e.kredsKey) ? e.kredsKey : "1";
        byK.get(k).push(e);
      }
      return byK;
    }

    function renderKredsLists(ds) {
      const container = document.getElementById('kredsLists');
      container.innerHTML = '';

      const byK = groupEntriesByKredsKey(ds);

      for (const o of KREDS_OPTIONS) {
        const list = byK.get(o.key) || [];
        const det = document.createElement('details');
        det.open = list.length > 0;
        det.style.marginTop = "10px";

        const visCount = list.filter(e => isEntryVisible(ds, e)).length;
        det.innerHTML = `
          <summary>
            ${escapeHtml(o.label)}
            <span class="summaryRight">${list.length} (viser ${visCount})</span>
          </summary>
          <div style="margin-top:10px;">
            ${list.length === 0 ? `<div class="hint">Ingen steder.</div>` : `
              <table>
                <thead>
                  <tr>
                    <th style="width: 34%;">Navn</th>
                    <th style="width: 46%;">Adresse</th>
                    <th style="width: 20%;">Handling</th>
                  </tr>
                </thead>
                <tbody id="tbody_k_${o.key}"></tbody>
              </table>
            `}
          </div>
        `;
        container.appendChild(det);

        if (list.length) {
          const tbody = det.querySelector(`#tbody_k_${CSS.escape(o.key)}`);
          tbody.innerHTML = "";

          for (const e of list) {
            const tr = document.createElement('tr');
            const isEditing = ds.editingIds.has(e.id);

            if (!isEditing) {
              tr.innerHTML = `
                <td>${escapeHtml(e.name || '(uden navn)')}</td>
                <td>${escapeHtml(e.address)}</td>
                <td>
                  <div class="actions">
                    <button class="mini" data-edit="${e.id}" type="button">Redigér</button>
                  </div>
                </td>
              `;
            } else {
              tr.innerHTML = `
                <td>
                  <div style="display:grid; gap:6px;">
                    <select class="inlineSelect" data-editkreds="${e.id}"></select>
                    <input class="inlineInput" data-editname="${e.id}" value="${escapeHtml(e.name || '')}" placeholder="Navn"/>
                  </div>
                </td>

                <td>
                  <div style="display:grid; gap:6px;">
                    <input class="inlineInput" data-editaddr="${e.id}" value="${escapeHtml(e.address || '')}" placeholder="Adresse"/>
                    <div class="row2" style="gap:6px;">
                      <select class="inlineSelect" data-editcolor="${e.id}"></select>
                      <input class="inlineNumber" type="number" min="2" max="20" data-editradius="${e.id}" value="${escapeHtml(e.radius)}"/>
                    </div>
                  </div>
                </td>

                <td>
                  <div class="actions">
                    <button class="mini primary" data-save="${e.id}" type="button">Gem</button>
                    <button class="mini" data-cancel="${e.id}" type="button">Fortryd</button>
                    <button class="mini" data-del="${e.id}" type="button">Slet</button>
                  </div>
                </td>
              `;
            }

            if (!isEntryVisible(ds, e)) tr.style.opacity = "0.5";
            tbody.appendChild(tr);

            if (isEditing) {
              const kredsSel = tr.querySelector(`select[data-editkreds="${CSS.escape(e.id)}"]`);
              const colorSel = tr.querySelector(`select[data-editcolor="${CSS.escape(e.id)}"]`);
              if (kredsSel) populateKredsSelect(kredsSel, e.kredsKey);
              if (colorSel) populateColorSelect(colorSel, e.color);
            }
          }
        }
      }

      // bind delete (kun i redigér) + confirm
      container.querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm("Er du sikker på, at du vil slette dette sted?")) return;

          const id = btn.getAttribute('data-del');
          const idx = ds.entries.findIndex(x => x.id === id);
          if (idx < 0) return;

          const e = ds.entries[idx];
          const m = ds.markerById.get(e.id);
          if (m) {
            if (ds.layerGroup.hasLayer(m)) ds.layerGroup.removeLayer(m);
            m.remove();
            ds.markerById.delete(e.id);
          }

          ds.editingIds.delete(e.id);
          ds.backups.delete(e.id);

          ds.entries.splice(idx, 1);
          saveState(ds);
          renderKredsLists(ds);
          updateVisibility(ds);
          setStatus('');
        });
      });

      container.querySelectorAll('button[data-edit]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-edit');
          const e = ds.entries.find(x => x.id === id);
          if (!e) return;

          ds.backups.set(id, { ...e });
          ds.editingIds.add(id);
          renderKredsLists(ds);
          setStatus('');
        });
      });

      container.querySelectorAll('button[data-cancel]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-cancel');
          const e = ds.entries.find(x => x.id === id);
          const b = ds.backups.get(id);
          if (e && b) {
            Object.assign(e, b);
            ensureMarker(ds, e);
            updateMarkerStyleAndPopup(ds, e);
            updateVisibility(ds);
          }
          ds.editingIds.delete(id);
          ds.backups.delete(id);
          renderKredsLists(ds);
          setStatus('');
        });
      });

      container.querySelectorAll('button[data-save]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-save');
          const e = ds.entries.find(x => x.id === id);
          const b = ds.backups.get(id);
          if (!e || !b) return;

          const kredsSel = container.querySelector(`select[data-editkreds="${CSS.escape(id)}"]`);
          const nameInp  = container.querySelector(`input[data-editname="${CSS.escape(id)}"]`);
          const addrInp  = container.querySelector(`input[data-editaddr="${CSS.escape(id)}"]`);
          const colorSel = container.querySelector(`select[data-editcolor="${CSS.escape(id)}"]`);
          const radInp   = container.querySelector(`input[data-editradius="${CSS.escape(id)}"]`);

          const newKredsKey = String(kredsSel?.value || "");
          const newName  = (nameInp?.value ?? "").trim();
          const newAddr  = (addrInp?.value ?? "").trim();
          const newColor = (colorSel?.value ?? e.color);
          const newRad   = clampRadius(radInp?.value ?? e.radius);

          if (!newKredsKey || !KREDS_LABEL_BY_KEY[newKredsKey]) { setStatus('Vælg en kreds/kategori.'); return; }
          if (!newAddr) { setStatus('Adresse må ikke være tom.'); return; }

          const oldAddr = e.address;

          e.kredsKey = newKredsKey;
          e.name = newName;
          e.address = newAddr;
          e.color = newColor;
          e.radius = newRad;

          try {
            if (newAddr !== oldAddr) {
              const r = await geocodeAndSetCoords(ds, e, { flyTo: true });
              if (!r.ok) throw new Error("Ingen match på adresse");
            } else {
              ensureMarker(ds, e);
              updateMarkerStyleAndPopup(ds, e);
              updateVisibility(ds);
            }

            ds.editingIds.delete(id);
            ds.backups.delete(id);
            saveState(ds);
            renderKredsLists(ds);
            setStatus('');
          } catch (err) {
            Object.assign(e, b);
            ensureMarker(ds, e);
            updateMarkerStyleAndPopup(ds, e);
            updateVisibility(ds);

            setStatus(
              'Kunne ikke gemme ændringer.\n' +
              'Hvis du åbner som file://, så prøv via http://localhost (lokal server).\n\n' +
              `Fejl: ${String(err?.message || err)}`
            );
          }
        });
      });

      updateSummaries(ds);
    }

    // ----------------- Add handler -----------------
    async function addEntry() {
      const ds = active();
      const btn = document.getElementById('add');
      btn.disabled = true;

      const kredsKey = String(document.getElementById('kreds').value || "");
      const name = document.getElementById('name').value.trim();
      const address = document.getElementById('address').value.trim();
      const color = document.getElementById('color').value;
      const radius = clampRadius(document.getElementById('radiusNumber').value);

      if (!kredsKey || !KREDS_LABEL_BY_KEY[kredsKey]) {
        setStatus('Vælg en kreds/kategori før du tilføjer.');
        btn.disabled = false;
        return;
      }
      if (!address) {
        setStatus('Skriv en adresse før du tilføjer.');
        btn.disabled = false;
        return;
      }

      const e = { id: uuid(), kredsKey, name, address, color, radius, opacity: ds.defaultOpacity, lat: undefined, lng: undefined };
      ds.entries.push(e);
      renderKredsLists(ds);
      setStatus('');

      try {
        const r = await geocodeAndSetCoords(ds, e, { flyTo: true });
        if (!r.ok) throw new Error("Ingen match");

        document.getElementById('name').value = '';
        document.getElementById('address').value = '';
        document.getElementById('address').focus();

        saveState(ds);
        renderKredsLists(ds);
        updateVisibility(ds);
        setStatus('');
      } catch (err) {
        const idx = ds.entries.findIndex(x => x.id === e.id);
        if (idx >= 0) ds.entries.splice(idx, 1);
        renderKredsLists(ds);
        updateVisibility(ds);

        setStatus(
          'Kunne ikke hente koordinater.\n' +
          'Hvis du åbner som file://, så prøv via http://localhost (lokal server).\n\n' +
          `Fejl: ${String(err?.message || err)}`
        );
      } finally {
        btn.disabled = false;
      }
    }

    // ----------------- Bulk handlers -----------------
    function applyBulkRadius() {
      const ds = active();
      const targets = getBulkTargets(ds);
      const r = clampRadius(document.getElementById('bulkRadiusNumber').value);
      if (targets.length === 0) { setStatus('Ingen steder matcher den valgte farve.'); return; }

      for (const e of targets) {
        e.radius = r;
        ensureMarker(ds, e);
        updateMarkerStyleAndPopup(ds, e);
      }
      saveState(ds);
      renderKredsLists(ds);
      updateVisibility(ds);
      setStatus('');
    }

    function applyBulkColor() {
      const ds = active();
      const targets = getBulkTargets(ds);
      const c = document.getElementById('bulkColor').value;
      if (targets.length === 0) { setStatus('Ingen steder matcher den valgte farve.'); return; }

      for (const e of targets) {
        e.color = c;
        ensureMarker(ds, e);
        updateMarkerStyleAndPopup(ds, e);
      }
      saveState(ds);
      renderKredsLists(ds);
      updateVisibility(ds);
      setStatus('');
      updateBulkTargetHint(ds);
    }

    const bulkOpacityRange = document.getElementById('bulkOpacityRange');
    const bulkOpacityNumber = document.getElementById('bulkOpacityNumber');

    function syncBulkOpacityFrom(source) {
      const ds = active();
      const op = clampOpacity(source.value, ds.defaultOpacity);

      ds.defaultOpacity = op;
      bulkOpacityRange.value = String(op);
      bulkOpacityNumber.value = String(op);

      const targets = getBulkTargets(ds);
      if (targets.length === 0 && ds.entries.length > 0) {
        setStatus('Ingen steder matcher den valgte farve.');
        saveState(ds);
        return;
      }

      for (const e of targets) {
        e.opacity = op;
        ensureMarker(ds, e);
        updateMarkerStyleAndPopup(ds, e);
      }

      saveState(ds);
      renderKredsLists(ds);
      updateVisibility(ds);
      setStatus('');
    }

    // ----------------- Sidebar resizer -----------------
    function setSidebarWidth(px) {
      const w = Math.max(280, Math.min(720, Math.round(px)));
      document.documentElement.style.setProperty('--sidebar', w + 'px');
      requestAnimationFrame(() => map.invalidateSize());
      try { localStorage.setItem(UI_KEY, JSON.stringify({ sidebarWidth: w })); } catch {}
    }

    function loadSidebarWidth() {
      try {
        const raw = localStorage.getItem(UI_KEY);
        if (!raw) return;
        const s = JSON.parse(raw);
        const w = Number(s.sidebarWidth);
        if (Number.isFinite(w)) setSidebarWidth(w);
      } catch {}
    }

    function initResizer() {
      const handle = document.getElementById('resizer');
      let dragging = false;
      let startX = 0;
      let startW = 0;

      const onMove = (e) => {
        if (!dragging) return;
        setSidebarWidth(startW + (e.clientX - startX));
      };
      const onUp = () => {
        dragging = false;
        document.body.style.userSelect = '';
        window.removeEventListener('mousemove', onMove);
        window.removeEventListener('mouseup', onUp);
      };

      handle.addEventListener('mousedown', (e) => {
        dragging = true;
        startX = e.clientX;
        const cs = getComputedStyle(document.documentElement);
        startW = parseInt(cs.getPropertyValue('--sidebar'), 10) || 420;
        document.body.style.userSelect = 'none';
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
      });

      handle.addEventListener('dblclick', () => setSidebarWidth(420));
    }

    // ----------------- Tabs -----------------
    function applyTabText() {
      const ds = active();

      const pageTitle = document.getElementById('pageTitle');
      const listTitle = document.getElementById('listTitle');
      const bulkTitle = document.getElementById('bulkTitle');

      if (ds.id === "valg") {
        document.title = "Tilføj valgsteder";
        pageTitle.textContent = "Tilføj valgsteder";
        listTitle.textContent = "Valgsteder fordelt på kreds";
        bulkTitle.textContent = "Ændringer for alle valgsteder";
        document.getElementById('clearAllStorage').textContent = "Slet alle gemte valgsteder";
      } else {
        document.title = "Tilføj brevstemmesteder";
        pageTitle.textContent = "Tilføj brevstemmesteder";
        listTitle.textContent = "Brevstemmesteder fordelt på kreds";
        bulkTitle.textContent = "Ændringer for alle brevstemmesteder";
        document.getElementById('clearAllStorage').textContent = "Slet alle gemte brevstemmesteder";
      }
    }

    function setActiveTab(id) {
      if (id === activeId) return;

      // skift knap-styling
      document.getElementById('tabValg').classList.toggle('active', id === "valg");
      document.getElementById('tabBrev').classList.toggle('active', id === "brev");

      // fjern nuværende gruppe fra kortet
      const prev = active();
      if (map.hasLayer(prev.layerGroup)) map.removeLayer(prev.layerGroup);

      activeId = id;

      // sørg for state loaded
      const ds = active();
      loadState(ds);

      // seed kun på valg
      seedDefaultIfNeeded(ds);

      // add gruppe
      if (!map.hasLayer(ds.layerGroup)) ds.layerGroup.addTo(map);

      // sørg for markører oprettet hvis coords findes
      for (const e of ds.entries) {
        if (typeof e.opacity !== "number") e.opacity = ds.defaultOpacity;
        ensureMarker(ds, e);
        updateMarkerStyleAndPopup(ds, e);
      }

      // UI
      applyTabText();
      refreshStatus();

      bulkOpacityRange.value = String(ds.defaultOpacity);
      bulkOpacityNumber.value = String(ds.defaultOpacity);

      renderKredsFilters(ds);
      renderKredsLists(ds);
      updateVisibility(ds);
      updateSummaries(ds);

      // geocode hvis mangler coords
      geocodeAllMissing(ds);

      requestAnimationFrame(() => map.invalidateSize());
    }

    // ----------------- Init -----------------
    populateKredsSelect(document.getElementById('kreds'));
    populateColorSelect(document.getElementById('color'), COLOR_PRESETS[0].value);
    populateColorSelect(document.getElementById('bulkColor'), COLOR_PRESETS[0].value);
    populateBulkTargetColor();

    loadSidebarWidth();
    initResizer();

    // load begge datasæt (så tab-skift er hurtigt)
    loadState(datasets.valg);
    loadState(datasets.brev);

    // seed valgsteder hvis tom
    seedDefaultIfNeeded(datasets.valg);

    // opret markører for begge datasæt (kun dem med coords)
    for (const ds of [datasets.valg, datasets.brev]) {
      for (const e of ds.entries) {
        if (typeof e.opacity !== "number") e.opacity = ds.defaultOpacity;
        ensureMarker(ds, e);
        updateMarkerStyleAndPopup(ds, e);
      }
    }

    // start på Valgsteder
    applyTabText();
    bulkOpacityRange.value = String(datasets.valg.defaultOpacity);
    bulkOpacityNumber.value = String(datasets.valg.defaultOpacity);

    renderKredsFilters(datasets.valg);
    renderKredsLists(datasets.valg);
    updateVisibility(datasets.valg);
    updateSummaries(datasets.valg);
    refreshStatus();

    addCphRing2Overlay();

    // geocode manglende coords (valg + brev)
    geocodeAllMissing(datasets.valg);
    geocodeAllMissing(datasets.brev);

    // bind
    document.getElementById('add').addEventListener('click', addEntry);

    document.getElementById('applyBulkRadius').addEventListener('click', applyBulkRadius);
    document.getElementById('applyBulkColor').addEventListener('click', applyBulkColor);

    document.getElementById('kredsAll').addEventListener('click', () => setAllKredse(active(), true));
    document.getElementById('kredsNone').addEventListener('click', () => setAllKredse(active(), false));

    document.getElementById('bulkTargetColor').addEventListener('change', () => updateBulkTargetHint(active()));

    bulkOpacityRange.addEventListener('input', () => syncBulkOpacityFrom(bulkOpacityRange));
    bulkOpacityNumber.addEventListener('input', () => syncBulkOpacityFrom(bulkOpacityNumber));

    document.getElementById('address').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('add').click();
      }
    });

    document.getElementById('clearAllStorage').addEventListener('click', () => {
      const ds = active();
      if (!confirm("Vil du slette alt gemt for denne fane?")) return;

      clearStorage(ds);

      // fjern markører
      for (const m of ds.markerById.values()) {
        if (ds.layerGroup.hasLayer(m)) ds.layerGroup.removeLayer(m);
        m.remove();
      }
      ds.markerById.clear();

      ds.entries.splice(0, ds.entries.length);
      ds.editingIds.clear();
      ds.backups.clear();
      ds.statusMsg = "";

      ds.selectedKredse.clear();
      for (const o of KREDS_OPTIONS) ds.selectedKredse.add(o.key);

      renderKredsFilters(ds);
      renderKredsLists(ds);
      updateVisibility(ds);
      updateSummaries(ds);
      refreshStatus();
    });

    // tabs
    document.getElementById('tabValg').addEventListener('click', () => setActiveTab("valg"));
    document.getElementById('tabBrev').addEventListener('click', () => setActiveTab("brev"));

  </script>
</body>
</html>
